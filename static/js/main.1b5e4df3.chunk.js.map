{"version":3,"sources":["game/net/messageEncoder.worker.ts","resources/sheet-composite.enc.png","game/util/unscramble.js","../node_modules/peerjs/dist sync","webpack:///./src/game/net/messageEncoder.worker.ts?773d","webpack:///./src/game/data/board-packer.worker.ts?e9c0","game/util/draggable.ts","game/consts.ts","game/util/sprite-loading.ts","game/controllers/canvas.ts","game/db/metadata-db.ts","game/net/handlers/handler.ts","game/net/crypter.ts","game/net/packets/packet-list.ts","ui-components/notifications.ts","game/data/protobufs/proto-wrapper.ts","game/data/protobufs/proto-sprite.ts","game/data/protobufs/proto-entity.ts","game/data/protobufs/proto-tiles.ts","game/net/packets/terrainPackets.ts","game/net/packets/entityPackets.ts","game/net/packets/util-packets.ts","game/net/messageEncoder.ts","game/net/peerconnection.ts","game/util/promiseStream.ts","game/data/interfaces/tile.ts","game/net/handlers/terrain-add-handler.ts","game/net/handlers/terrain-erase-handler.ts","game/controllers/terrain.ts","game/middleware/middleware.ts","game/middleware/entity-events.ts","game/net/handlers/entity-update-handler.ts","game/controllers/entities.ts","game/net/prechecks/precheck.ts","game/db/user-db.ts","game/net/prechecks/signature-check.ts","game/net/prechecks/board-sync-check.ts","game/controllers/lobby.ts","game/net/handlers/ping-handler.ts","game/db/board-db.ts","game/controllers/campaign.ts","game/util/deproxy.ts","game/db/campaign-db.ts","game/data/campaign-loader.ts","game/net/handlers/board-reload-handler.ts","game/controllers/game.ts","ui-tools/ui-tool.tsx","game/middleware/pen-events.ts","ui-components/spritepicker.tsx","ui-tools/ui-pen-tool.tsx","ui-tools/ui-camera-tool.tsx","ui-tools/ui-eraser-tool.tsx","ui-tools/ui-entity-tool.tsx","ui-tools/ui-lobby-tool.tsx","ui-components/controlMenu.tsx","ui-components/prompts.tsx","ui-components/loginHelper.tsx","ui-components/connectionOverlay.tsx","ui-components/campaignSelector.tsx","ui-components/boardSelector.tsx","ui-components/boardSaveButton.tsx","App.tsx","serviceWorker.ts","index.tsx","game/data/board-packer.worker.ts"],"names":["module","exports","wrap","__esModule","shuffleSeed","require","img","sliceSize","seed","bmp","i","ctx","totalParts","Math","ceil","width","height","inds","push","canvas","document","createElement","getContext","verticalSlices","getGroup","slices","self","length","cols","t","y","getColsInGroup","rows","x","slice","row","parseInt","col","getSlices","g","group","shuffleInd","shuffle","s","drawImage","webpackEmptyContext","req","e","Error","code","keys","resolve","id","Worker","pan","state","originX","originY","transformation","translateX","translateY","element","style","transform","getMatrix","scale","canPan","panBy","panTo","canZoom","zoom","deltaScale","getBoundingClientRect","left","top","minScale","maxScale","scaleSensitivity","getScale","newScale","newOriginX","newOriginY","translate","getTranslate","pos","prevPos","transformOrigin","max","min","valueInRange","listeners","listen","ele","event","cb","opts","addEventListener","rem","removeEventListener","Draggable","parent","instance","Object","assign","renderer","dragging","lx","ly","evCache","noScroll","Set","prevDiff","preventDefault","sign","deltaY","pageX","pageY","blocking","ev","splice","clear","clientX","clientY","window","pointerId","curDiff","abs","sqrt","pow","delta","change","add","has","delete","unregister","forEach","l","fpsTicker","CanvasContainer","base","wrapper","canvases","this","className","backgroundColor","prepend","body","setCanvasSize","resetView","setSize","appendTo","object","appendChild","removeChild","c","rect","console","log","coords","boardTileWidth","floor","boardTileHeight","Canvas","name","context","append","mdl","attach","rawData","unscramble","data","sheet","spriteWidth","metadata","spriteHeight","globalFrameIndex","waitForSpriteLoad","Promise","res","Image","onerror","err","error","alert","onload","src","sheetSRC","clearInterval","setInterval","findSpriteData","key","ret","sprites","composite","Cats","Sprite","idx","images","drawImageTo","blocker","Handler","packets","isHost","client","packet","hostHandler","clientHandler","currentUsername","observable","box","db","version","stores","table","catType","JSON","where","dexKey","first","val","parse","toArray","map","ob","put","stringify","Dexie","getCerts","a","get","CERT","pubKey","privKey","setCerts","pub","privateCert","store","setUsername","username","set","USER","getUsername","campaign","privateKey","publicKey","roomID","strToBuffer","text","buf","ArrayBuffer","bufView","Uint16Array","strLen","charCodeAt","bufferToStr","buffer","String","fromCharCode","apply","hash","message","crypto","subtle","digest","hashBuffer","Array","from","Uint8Array","b","toString","padStart","join","initKeys","regenKeys","debug","hydrate","getMyRoomID","generateKey","namedCurve","pair","exportKeys","keyJSON","mode","importKey","exportKey","substr","rID","encoded","signature","verify","pack","sig","_sig","unpack","objStr","hashStr","indexOf","snackbarRef","SnackbarUtilsConfigurator","useSnackbar","success","msg","options","toast","variant","warning","info","enqueueSnackbar","ProtoWrapper","values","Message","ProtoSprite","Type","d","Field","ProtoEntity","entity","sprite","owners","ProtoTile","ProtoTileStack","ProtoBoard","TerrainAddPacket","TerrainCoordPacket","TerrainErasePacket","EntityUpdatePacket","EntityDeletePacket","PingPacket","SignaturePacket","ReadyPacket","packetList","packetMap","encode","constructor","worker","decode","clazz","NetworkStatus","NetworkMode","PromiseStream","maxBackpressure","prom","backPressure","fn","onError","then","catch","handlers","preConn","clients","_peer","netStatus","IDLE","netMode","UNKNOWN","setHandlers","newHandlers","newPreConn","peer","makeNew","destroy","MATCHMAKING","Peer","host","port","path","secure","rej","on","notifications","preventDuplicate","autoHideDuration","MATCHMAKING_FAIL","connectTo","setMode","CLIENT","RECONNECTING","CONNECTING","p","conn","connect","reliable","Client","shouldReconnect","clientError","WAITING_FOR_HOST","pc","run","verified","CONNECTED","warn","removeClient","close","DISCONNECTED","openHost","HOST","server","cli","kill","listener","lastSend","stream","userData","keyCodes","lastSeen","pingTimer","lastPing","hook","open","Date","now","send","queue","handleMessage","packetBinary","encoder","h","some","$type","handlePacket","clearTimeout","sendBuffer","expectedType","broadcast","requireHost","Tile","z","TerrainAddHandler","terrain","tileStacks","stack","tiles","removeAt","dt","sp","spriteIdx","placeAt","setTimeout","broadcastChanges","pollChanges","packedStacks","updateTiles","packer","TerrainEraseHandler","size","tep","Terrain","boardWidth","boardHeight","tileIDX","resizeBoard","tList","redraw","exists","mkKey","redrawAt","sendTerrainRemove","isBoardDirty","tile","existing","getAt","isBlocker","k","filter","sendTerrainAdd","selectedSprite","covered","px","py","clearRect","drawTo","newTerrain","sort","Middleware","hooks","onCleanup","register","target","wrapped","stopPropagation","trg","EntityMiddleware","container","entLayer","ent","moveListener","movePoints","moveTrackers","entityLayer","entEle","clearMover","toggleInput","bringToFront","toGrid","addPoint","mp","remove","last","findIndex","checkDiag","redrawPath","updateEntity","third","distance","reduce","prev","next","dst","innerText","pathLength","p1","p2","offsetX","offsetY","EntityUpdateHandler","entities","addEntity","entityID","entityIsOwned","canMove","visible","proto","Entity","init","uuid","includes","NamePlate","color","targY","plates","update","reposition","offsetWidth","offsetHeight","o","overlaps","position","other","right","bottom","n","updateTimer","EntityEle","plateParent","onClick","namePlate","redrawTimer","opacity","props","requestAnimationFrame","animated","bind","cursor","imageWidthPx","useInput","EntityLayer","tileWidth","tileHeight","entityElements","plateEle","enableInput","middleware","sendUpdate","sendDelete","selected","select","setInput","isDirty","setTarget","checkOwner","internalUpdate","enabled","acceptHover","PreCheck","controller","runHandler","users","addNewUser","user","getTime","updateUser","getUser","checkUserCredentials","userName","keyCode","match","HandShakeCheck","getNextPacket","pk","signedJSON","raw","lobby","addPendingLogin","BoardSync","buildProtoBoard","Lobby","blacklist","title","iconURL","Notification","requestPermission","result","icon","approve","reject","pendingLogins","find","pe","pending","removePending","notify","u","PingHandler","handlePing","boards","save","campaignID","board","load","getAvailable","between","minKey","maxKey","deleteBoard","Campaign","timeCreated","stripProxy","obj","entries","v","campaigns","saveCampaign","camp","createCampaign","getAllCampaigns","getCampaign","mapToClass","CampaignLoader","boardDB","loadedBoard","BoardReloadHandler","loadFromProtoBoard","GameController","canvasContainer","preChecks","addLayer","location","replace","startHost","startClient","ready","history","pushState","href","connection","pu","rejectUser","setHost","connectID","pb","setDirectMap","getEntityList","includeHidden","getDirectMap","flat","fromEntity","UITool","PenMiddleware","canUsePen","hoverBox","toggle","addElement","ke","startsWith","updateHighlight","shiftKey","button","xx","yy","draw","out","penSize","eraseAt","drawAt","border","op","removeElement","SpritePicker","React","useState","defaultTerm","searchTerm","setSearch","setAnimated","setSprites","useEffect","timeout","results","term","nameOnly","search","toLowerCase","searchImages","maxWidth","noValidate","autoComplete","onSubmit","FormGroup","Autocomplete","selectOnFocus","freeSolo","value","inputValue","onInputChange","newInputValue","onSearch","renderInput","params","TextField","label","FormControlLabel","control","Switch","checked","onChange","disabled","canAnimate","inputProps","labelPlacement","SpriteGrid","onSelect","perRow","rowCount","columnCount","columnWidth","rowHeight","maxHeight","spr","columnIndex","rowIndex","SpriteImage","canv","useRef","sel","current","cancel","ref","background","useStyles","makeStyles","theme","createStyles","paper","palette","boxShadow","shadows","padding","spacing","pointerEvents","minWidth","SpritePickerModal","classes","Modal","aria-labelledby","aria-describedby","onClose","currentSprite","UIPenTool","forMobile","PenControlInterface","pen","registerMiddleware","eject","observer","PenSizeSlider","Typography","gutterBottom","Slider","getAriaValueText","valueLabelDisplay","step","marks","newValue","UICameraTool","UIEraserTool","EraserSizeSlider","UIEntityTool","EntityInterface","root","flexGrow","speedDial","spriteColor","marginLeft","marginTop","marginRight","promptSprite","setSpritePrompt","setSprite","entName","setName","setVisible","resetValues","EntityEditInterface","evt","Checkbox","justifyContent","Button","screenToBoard","innerWidth","innerHeight","createEntity","trim","prompt","promptClone","setClonePrompt","useMemo","updateInstant","clientNames","cl","userList","type","saveToCampaign","InputLabel","Select","multiple","input","Input","renderValue","marginBottom","MenuItem","ListItemText","primary","PromptForNumber","onCancel","num","cloneEntity","setNum","Dialog","DialogTitle","DialogContent","DialogContentText","autoFocus","margin","fullWidth","DialogActions","UILobbyTool","LobbyInterface","PendingList","UserList","eles","pl","MenuList","PendingUserEle","disableTouchRipple","Tooltip","IconButton","children","approveUser","network","dat","ControlMenu","ui","setOpen","modalOpen","setModalOpen","tools","setTools","selectedTool","setSelected","handleClose","handleModalClose","emb","getControlUI","Avatar","SpeedDial","ariaLabel","hidden","SpeedDialIcon","onOpen","isOption","action","SpeedDialAction","tooltipTitle","tooltipOpen","handleSelect","InputDialog","setText","tooltip","acceptText","ConfirmPrompt","cancelButton","onConfirm","confirmButton","LoginHelper","promptLogin","setPrompt","needClient","setNeedClient","PromptNetwork","hosting","txt","ConnectionOverlay","content","Backdrop","transitionDuration","component","CampaignSelector","need","setNeed","wantOpen","setWantOpen","promptNew","setPromptNew","campaignList","setList","q","storage","setStorage","selectCampaign","Metadata","loadBoard","loadCampaign","navigator","estimate","usage","quota","undefined","addCampaign","Fab","textAlign","CampaignMenu","startIcon","toFixed","bytes","decimals","dm","sizes","parseFloat","formatBytes","anchorEl","setAnchorEl","camps","c1","c2","toLocaleString","htmlFor","currentTarget","overflowX","Menu","keepMounted","Boolean","anchorOrigin","vertical","horizontal","BoardSelector","noWrap","Popover","BoardControlMenu","BoardSelectMenu","overflow","BoardLoadButton","BoardDeleteButton","confirm","needConfirm","BoardCreateButton","needPrompt","handleCreate","BoardSaveButton","shouldSave","saveBoard","noop","App","desktop","useMediaQuery","needName","setNeedName","start","reload","isNetworkReady","CircularProgress","maxSnack","display","flexDirection","hostname","ReactDOM","render","getElementById","serviceWorker","registration"],"mappings":"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","file":"static/js/main.1b5e4df3.chunk.js","sourcesContent":["module.exports = require('comlink').wrap(require(\"!worker-loader?{}!/home/runner/work/Terra/Terra/web-ui/node_modules/comlink-loader/dist/comlink-worker-loader.js!/home/runner/work/Terra/Terra/web-ui/node_modules/react-scripts/node_modules/babel-loader/lib/index.js??ref--7-oneOf-1!/home/runner/work/Terra/Terra/web-ui/node_modules/eslint-loader/dist/cjs.js??ref--6-0!/home/runner/work/Terra/Terra/web-ui/src/game/net/messageEncoder.worker.ts\")());module.exports.__esModule = true;","module.exports = __webpack_public_path__ + \"static/media/sheet-composite.enc.52e99977.png\";","/*\n * converted from https://www.npmjs.com/package/image-scramble\n */\nvar shuffleSeed = require('shuffle-seed');\n\nvar self = function(img,sliceSize,seed,bmp){\n\tvar i;\n\tvar totalParts = Math.ceil(img.width/sliceSize)*Math.ceil(img.height/sliceSize);\n\tvar inds = [];\n\tvar ctx;\n\tfor(i=0;i<totalParts;i++) inds.push(i);\n\tif(!bmp){\n\t\tvar canvas=document.createElement(\"canvas\");\n\t\tctx=canvas.getContext('2d');\n\t\tcanvas.width=img.width;\n\t\tcanvas.height=img.height;\n\t}\n\n\n\tvar verticalSlices=Math.ceil(img.width/sliceSize);\n\n\tvar getSlices = function(){\n\t\tvar slices = {};\n\t\tvar i;\n\t\tfor(i=0;i<totalParts;i++){\n\t\t\tvar slice = {};\n\t\t\tvar row=parseInt(i/verticalSlices);\n\t\t\tvar col=i-row*verticalSlices;\n\t\t\tslice.x=col*sliceSize;\n\t\t\tslice.y=row*sliceSize;\n\t\t\tslice.width=(sliceSize-(slice.x+sliceSize<=img.width ?  0 : (slice.x+sliceSize)-img.width));\n\t\t\tslice.height=(sliceSize-(slice.y+sliceSize<=img.height ?  0 : (slice.y+sliceSize)-img.height));\n\t\t\tif(!slices[slice.width+\"-\"+slice.height]) slices[slice.width+\"-\"+slice.height]=[];\n\t\t\tslices[slice.width+\"-\"+slice.height].push(slice);\n\t\t}\n\t\treturn slices;\n\t}\n\n\tvar getColsInGroup = function(slices){\n\t\tif(slices.length===1) return 1;\n\t\tvar t = 'init';\n\t\tfor(var i=0;i<slices.length;i++){\n\t\t\tif(t==='init') t = slices[i].y;\n\t\t\tif(t!==slices[i].y){\n\t\t\t\treturn i;\n\t\t\t}\n\t\t}\n\t\treturn i;\n\t}\n\n\tvar getGroup = function(slices){\n\t\tvar self = {};\n\t\tself.slices = slices.length;\n\t\tself.cols = getColsInGroup(slices);\n\t\tself.rows = slices.length/self.cols;\n\t\tself.width = slices[0].width*self.cols;\n\t\tself.height = slices[0].height*self.rows;\n\t\tself.x = slices[0].x;\n\t\tself.y = slices[0].y;\n\t\treturn self;\n\t}\n\n\tvar slices = getSlices();\n\tfor(var g in slices){\n\t\tvar group = getGroup(slices[g]);\n\t\tvar shuffleInd = [];\n\t\tfor(i=0;i<slices[g].length;i++) shuffleInd.push(i);\n\t\tshuffleInd = shuffleSeed.shuffle(shuffleInd,seed);\n\t\tfor(i=0;i<slices[g].length;i++){\n\t\t\tvar s=shuffleInd[i];\n\n\t\t\tvar row=parseInt(s/group.cols);\n\t\t\tvar col=s-row*group.cols;\n\t\t\tvar x=col*slices[g][i].width;\n\t\t\tvar y=row*slices[g][i].height;\n\n\t\t\tctx.drawImage(\n\t\t\t\timg,\n\t\t\t\tgroup.x+x,\n\t\t\t\tgroup.y+y,\n\t\t\t\tslices[g][i].width,\n\t\t\t\tslices[g][i].height,\n\t\t\t\tslices[g][i].x,\n\t\t\t\tslices[g][i].y,\n\t\t\t\tslices[g][i].width,\n\t\t\t\tslices[g][i].height\n\t\t\t);\n\t\t}\n\t}\n\treturn canvas;\n}\n\nmodule.exports=self;\n","function webpackEmptyContext(req) {\n\tvar e = new Error(\"Cannot find module '\" + req + \"'\");\n\te.code = 'MODULE_NOT_FOUND';\n\tthrow e;\n}\nwebpackEmptyContext.keys = function() { return []; };\nwebpackEmptyContext.resolve = webpackEmptyContext;\nmodule.exports = webpackEmptyContext;\nwebpackEmptyContext.id = 190;","module.exports = function() {\n  return new Worker(__webpack_public_path__ + \"06367e8d5be890703149.worker.js\");\n};","module.exports = function() {\n  return new Worker(__webpack_public_path__ + \"eeb745a6c67db240a878.worker.js\");\n};","\nfunction renderer(minScale: number, maxScale: number, element: HTMLElement, scaleSensitivity: number = 10){\n    const state = {\n        element,\n        minScale,\n        maxScale,\n        scaleSensitivity,\n        transformation: {\n            originX: 0,\n            originY: 0,\n            translateX: 0,\n            translateY: 0,\n            scale: 1\n        },\n    };\n    return Object.assign({}, canZoom(state), canPan(state), {state});\n}\n\nconst pan = ({ state, originX, originY }: any) => {\n    state.transformation.translateX += originX;\n    state.transformation.translateY += originY;\n    state.element.style.transform =\n        getMatrix({ scale: state.transformation.scale, translateX: state.transformation.translateX, translateY: state.transformation.translateY });\n};\n\nconst canPan = (state: any) => ({\n    panBy: ({ originX, originY }: any) => pan({ state, originX, originY }),\n    panTo: ({ originX, originY, scale }: any) => {\n        state.transformation.scale = scale;\n        pan({ state, originX: originX - state.transformation.translateX, originY: originY - state.transformation.translateY });\n    },\n});\n\n\nconst canZoom = (state: any) => ({\n    zoom: ({ x, y, deltaScale }: any) => {\n        const { left, top } = state.element.getBoundingClientRect();\n        const { minScale, maxScale, scaleSensitivity } = state;\n        const [scale, newScale] = getScale({ scale: state.transformation.scale, deltaScale, minScale, maxScale, scaleSensitivity });\n        const originX = x - left;\n        const originY = y - top;\n        const newOriginX = originX / scale;\n        const newOriginY = originY / scale;\n        const translate = getTranslate({ scale, minScale, maxScale });\n        const translateX = translate({ pos: originX, prevPos: state.transformation.originX, translate: state.transformation.translateX });\n        const translateY = translate({ pos: originY, prevPos: state.transformation.originY, translate: state.transformation.translateY });\n\n        state.element.style.transformOrigin = `${newOriginX}px ${newOriginY}px`;\n        state.element.style.transform = getMatrix({ scale: newScale, translateX, translateY });\n        state.transformation = { originX: newOriginX, originY: newOriginY, translateX, translateY, scale: newScale };\n    }\n});\n\nconst getScale = ({ scale, minScale, maxScale, scaleSensitivity, deltaScale }: any) => {\n    let newScale = scale + (deltaScale / (scaleSensitivity / scale));\n    newScale = Math.max(minScale, Math.min(newScale, maxScale));\n    return [scale, newScale];\n};\n\nconst hasPositionChanged = ({ pos, prevPos }: any) => pos !== prevPos;\n\nconst valueInRange = ({ minScale, maxScale, scale }: any) => scale <= maxScale && scale >= minScale;\n\nconst getTranslate = ({ minScale, maxScale, scale }: any) => ({ pos, prevPos, translate }: any) =>\n    valueInRange({ minScale, maxScale, scale }) && hasPositionChanged({ pos, prevPos })\n        ? translate + (pos - prevPos * scale) * (1 - 1 / scale)\n        : translate;\n\nconst getMatrix = ({ scale, translateX, translateY }: any) =>\n    `matrix(${scale}, 0, 0, ${scale}, ${translateX}, ${translateY})`;\n\nconst listeners: any = [];\n\nfunction listen (ele: HTMLElement|Document|Window, event: string, cb: any, opts: any = {}) {\n    ele.addEventListener(event, cb);\n    const rem = () => ele.removeEventListener(event, cb, opts);\n    listeners.push(rem)\n    return rem;\n}\n\nexport default function Draggable(ele: HTMLElement, parent: HTMLElement) {\n    const instance = renderer(.65, 5, ele, 10);\n    let dragging = false;\n    let lx=0, ly=0;\n    // Global vars to cache event state\n    let evCache: any = [], noScroll = new Set();\n    let prevDiff = -1;\n    listen(parent, \"wheel\", (event: WheelEvent) => {\n        event.preventDefault();\n        instance.zoom({\n            deltaScale: Math.sign(event.deltaY) > 0 ? -1 : 1,\n            x: event.pageX,\n            y: event.pageY\n        });\n    }, { blocking: true });\n\n    listen(parent, 'mouseup', (ev: MouseEvent) => {\n        evCache.splice(0, evCache.length); // Don't cache events for mice.\n        noScroll.clear();\n        dragging = false;\n        prevDiff = -1;\n    });\n\n    // Pointer stuff:\n    listen(parent, 'pointerdown', (ev: PointerEvent) => {\n        evCache.push(ev);\n        lx = ev.clientX;\n        ly = ev.clientY;\n        dragging = true;\n    });\n    listen(window, 'pointermove', (ev: PointerEvent) => {\n        ev.preventDefault();\n        if (!dragging) return;\n        // Find this event in the cache and update its record with this event\n        for (let i = 0; i < evCache.length; i++) {\n            if (ev.pointerId === evCache[i].pointerId) {\n                evCache[i] = ev;\n                break;\n            }\n        }\n        // If two pointers are down, check for pinch gestures\n        if (evCache.length === 2) {\n            // Calculate the distance between the two pointers\n            let curDiff = Math.abs(Math.sqrt(Math.pow(evCache[0].clientX - evCache[1].clientX, 2) + Math.pow(evCache[0].clientY - evCache[1].clientY, 2)));\n\n            if (prevDiff > 0) {\n                let delta = prevDiff - curDiff;\n                let change = (Math.sign(delta) > 0 ? -0.2 : 0.2) * Math.abs(delta)/10;\n                instance.zoom({\n                    deltaScale: change,\n                    x: ev.pageX,\n                    y: ev.pageY\n                });\n                noScroll.add(evCache[0].pointerId);\n                noScroll.add(evCache[1].pointerId);\n            }\n\n            // Cache the distance for the next move event\n            prevDiff = curDiff;\n        } else if (evCache.length === 1 && dragging && !noScroll.has(ev.pointerId)) {\n            instance.panBy({\n                originX: ev.clientX - lx,\n                originY: ev.clientY - ly\n            });\n            lx = ev.clientX;\n            ly = ev.clientY;\n        }\n    });\n\n    listen(window, 'pointerup', (ev: PointerEvent) => {\n        // Remove this event from the target's cache\n        for (let i = 0; i < evCache.length; i++) {\n            if (evCache[i].pointerId === ev.pointerId) {\n                evCache.splice(i, 1);\n                break;\n            }\n        }\n        noScroll.delete(ev.pointerId);\n\n        if (evCache.length < 1) {\n            dragging = false;\n        }\n\n        // If the number of pointers down is less than two then reset diff tracker\n        if (evCache.length < 2) {\n            prevDiff = -1;\n        }\n    });\n\n    return Object.assign({}, instance, {unregister: () => listeners.forEach((l: any) => l())})\n}\n","/** The width of each image/tile, in pixels. */\nexport const imageWidthPx = 48;\n/** The height of each image/tile, in pixels. */\nexport const imageHeightPx = 48;\n\n/** The amount of terrain the board is wide. */\nexport const boardTileWidth = 100;\n/** The amount of terrain the board is tall. */\nexport const boardTileHeight = 100;\n","import sheetSRC from '../../resources/sheet-composite.enc.png';\nconst rawData = require('../../resources/sheet-data.json');\nconst unscramble = require('./unscramble');\n\ninterface DataSheet {\n\tmetadata: {\n\t\twidth: number;\n\t\theight: number;\n\t\tcount: number;\n\t\tuid: string;\n\t};\n\tsprites: Record<string, DataSprite>;\n}\n\ninterface DataSprite {\n\tname: string;\n\tanimated?: number;\n\timages: DataImage[];\n}\n\ninterface DataImage {\n\tx: number;\n\ty: number;\n\tblocker: boolean;\n}\n\nconst data: DataSheet = rawData;  // Type casting here for clarity.\nlet sheet: HTMLCanvasElement = document.createElement('canvas');\nlet spriteWidth: number = data.metadata.width;\nlet spriteHeight: number = data.metadata.height;\nlet globalFrameIndex: number = 0;\nlet fpsTicker: NodeJS.Timeout;\n\nexport const waitForSpriteLoad: Promise<any> = new Promise(res => {\n\tconst img = new Image();\n\timg.onerror = err => {\n\t\tconsole.error(err);\n\t\talert('Failed to waitForSpriteLoad sprite sheet! Cannot continue!');\n\t};\n\timg.onload = () => {\n\t\tsheet = unscramble(img, 24, 'GaiaV2SheetKey-mk1'); // Support the artists - buy from them!\n\t\tres();\n\t};\n\timg.src = sheetSRC;\n\n\tclearInterval(fpsTicker);\n\tfpsTicker = setInterval(() => {\n\t\tglobalFrameIndex++;\n\t\tglobalFrameIndex %= 1000;\n\t}, 200);\n});\n\n/**\n * Locates the metadata for a given Sprite. Raises an Error if the key cannot be found.\n * @param key\n */\nfunction findSpriteData(key: Sprite): DataSprite {\n\tconst ret = data.sprites[key.id];\n\tif (!ret) throw Error(`Unable to locate sprite for key: ${key.composite}`);\n\treturn ret;\n}\n\n/**\n * Render the image, denoted by the given Sprite, to the given Graphics 2D context.\n * @param ctx\n * @param key\n * @param x\n * @param y\n */\nfunction drawImageTo(ctx: CanvasRenderingContext2D, key: Sprite, x: number, y: number) {\n\tconst sprites = findSpriteData(key);\n\tconst img = key.idx < 0 ? sprites.images[globalFrameIndex % sprites.images.length] : sprites.images[key.idx];\n\n\tctx.drawImage(sheet, img.x, img.y, spriteWidth, spriteHeight, x, y, spriteWidth, spriteHeight);\n}\n\n/** Search for images matching the given term. */\nexport function searchImages(term: string, animated: boolean = false, nameOnly: boolean = false) {\n\tconst res: Sprite[] = [];\n\tconst search = Object.entries(data.sprites).filter( (obj) => {\n\t\tif (animated && !obj[1].animated) {\n\t\t\treturn false;\n\t\t}\n\t\tif (nameOnly) {\n\t\t\treturn obj[1].name.includes(term);\n\t\t}\n\n\t\treturn obj[0].includes(term.toLowerCase())\n\t}).map(o => ({ path: o[0], sprite: o[1]}));\n\tif (!animated) {\n\t\tsearch.forEach(o => {\n\t\t\tfor(let i=0; i < o.sprite.images.length; i++) {\n\t\t\t\tres.push(new Sprite(o.path, i));\n\t\t\t}\n\t\t})\n\t} else {\n\t\tsearch.forEach(o => {\n\t\t\tres.push(new Sprite(o.path, -1));\n\t\t})\n\t}\n\n\treturn res;\n}\n\n/**\n * SpriteKeys are used to concisely represent an image (by ID) from the datasheet,\n * as well as which index to use for animating.\n */\nexport class Sprite {\n\tpublic readonly id: string;\n\tpublic readonly idx: number;\n\n\tconstructor(id: string, idx: number) {\n\t\tthis.id = id;\n\t\tthis.idx = idx;\n\t}\n\n\tget composite(): string {\n\t\treturn `${this.id}:${this.idx}`;\n\t}\n\n\tget animated(): boolean {\n\t\treturn this.idx < 0;\n\t}\n\n\tget isBlocker(): boolean {\n\t\tif (this.idx < 0) return false;\n\t\treturn findSpriteData(this).images[this.idx].blocker;\n\t}\n\n\tget name(): string {\n\t\treturn findSpriteData(this).name;\n\t}\n\n\tpublic drawTo(ctx: CanvasRenderingContext2D, x: number, y: number) {\n\t\tdrawImageTo(ctx, this, x, y);\n\t}\n}\n\n\n/*\n\tWrapper for an entire sprite search/selection window.\n\tCreated with a default ID unless specified. All defaults are the same ID, and will overwrite each other to prevent HTML leaks.\n\tSupports hooking the \"onChange(function)\" function, in order to adjust settings.\n\n\tThe image, once selected and loaded/loading, can be reached through [picker].selected_image;\n*/\n/*class SpritePicker{\n\tconstructor(uid=false){\n\t\tlet self = this;\n\t\tthis.folder_base = 'https://rofl.wtf/dnd/';\n\t\tthis.uid = 0;\n\t\tif(uid)this.uid=uid;\n\t\tthis.selected_image = false;\n\t\tthis.on_change = function(){};\n\n\t\tthis.base = $(\"<div>\", {'class':'image_selector', id:'image_selector_'+self.uid});\n\t\tthis.preview = $(\"<div>\").addClass('selected_preview');\n\t\tthis.input = $(\"<input>\",{type:\"text\"});\n\t\tthis.imagelist = $(\"<div>\", {'class':'image_list'});\n\n\t\tthis.input.on(\"keyup\", function(e){\n\t\t\tif (e.keyCode === 13){\n\t\t\t\tself.searchImages($(this).val());\n\t\t\t}\n\t\t});\n\n\t\tthis.preview.on('mouseover', function(){\n\t\t\t// .position() uses position relative to the offset parent,\n\t\t\t// so it supports position: relative parent elements\n\t\t\tlet pos = $(this).offset();\n\n\t\t\t// .outerWidth() takes into account border and padding.\n\t\t\tlet offset = Math.max(0, pos.left -self.base.outerWidth());\n\t\t\t//show the menu directly over the placeholder\n\t\t\tself.base.css({\n\t\t\t\tposition: \"absolute\",\n\t\t\t\ttop: pos.top + \"px\",\n\t\t\t\tleft: offset + \"px\",\n\t\t\t\tzIndex: window.max_panel_index?window.max_panel_index:10,\n\t\t\t}).show();\n\t\t\tself.input.select();\n\t\t});\n\t\tthis.preview.add(this.base).mouseenter(function(){\n\t\t\tself.base.show();\n\t\t}).mouseleave(function() {\n\t\t\tself.base.hide();\n\t\t});\n\n\t\tthis.base.append($(\"<b>Search for Sprites:</b><br>\"));\n\t\tthis.base.append(this.input);\n\t\tthis.base.append(this.imagelist);\n\n\t\t$( \"#image_selector_\"+this.uid ).remove();\n\t\t$(document.body).append(this.base);\n\t\tthis.searchImages('/');\n\t}\n\n\tsetDefault(image){\n\t\tthis.selected_image = image;\n\t\tthis.updatePreview();\n\t}\n\n\t// noinspection JSUnusedGlobalSymbols\n\tsetColor(col){\n\t\tthis.preview.css('background-color', col);\n\t\tconsole.log(col);\n\t\tif(this.selected_image)\n\t\t\tthis.preview.css('background-color', 'inherit');\n\t}\n\n\tsearchImages(text){\n\t\tlet self = this;\n\t\tif(text.trim() === '' || !text)\n\t\t\treturn;\n\t\t$.getJSON( self.folder_base+\"images.php?term=\"+text, function( data ) {\n\t\t\tlet items = [];\n\t\t\t$.each( data, function( key, obj ) {\n\t\t\t\tif(obj['dir']){\n\t\t\t\t\tlet ele = $(\"<span>\", {'class':'loaded_dir'});\n\t\t\t\t\tlet an = $(\"<a>\", {title:obj.text});\n\t\t\t\t\tan.text(obj.text);\n\t\t\t\t\tan.on('click', function(){\n\t\t\t\t\t\tself.searchImages(obj.id);\n\t\t\t\t\t});\n\t\t\t\t\tele.append(an);\n\t\t\t\t\titems.push(ele);\n\t\t\t\t\titems.push($(\"<br>\"));\n\t\t\t\t}\n\t\t\t});\n\t\t\t$.each( data, function( key, obj ) {\n\t\t\t\tif(!obj['dir']){\n\t\t\t\t\t//let sp = $(\"<span/>\", {'class':'loaded_image'});\n\t\t\t\t\tlet im = $(\"<img />\", {src:self.folder_base+'/resources/images/spritesheets/crawl/' + obj.id, title:obj.text, 'class':'loaded_image'});\n\t\t\t\t\tim.on('click', function(){\n\t\t\t\t\t\tself.selectImage($(this));\n\t\t\t\t\t});\n\t\t\t\t\t//sp.append(im);\n\t\t\t\t\titems.push(im);\n\t\t\t\t}\n\t\t\t});\n\t\t\tself.imagelist.empty();\n\t\t\tlet sp = $(\"<span>\", {'class':'image_list_span'});\n\t\t\titems.forEach(function(e){sp.append(e);} );\n\t\t\tself.imagelist.append(sp);\n\t\t});\n\t}\n\n\tselectImage(ele){\n\t\t$( \".selected_image\" ).removeClass( \"selected_image\" );\n\t\tconsole.log(ele.attr('src'));\n\t\tthis.selected_image = sprites.getImage(ele.attr('src'));\n\t\tele.addClass(\"selected_image\");\n\n\t\tthis.updatePreview();\n\t\tthis.on_change();\n\n\t\tlet block = false;// Auto-adjust cursor solid box, for ease of use.\n\t\t['wall', 'closed', 'statue', 'tree', 'vault', 'altar', 'uf_map'].forEach(function(h){\n\t\t\tif(ele.attr('src').toLowerCase().includes(h.toLowerCase()))\n\t\t\t\tblock = true;\n\t\t});\n\t\tpen.setSolid(block);\n\t}\n\n\tupdatePreview(){\n\t\tif(this.selected_image){\n\t\t\tthis.preview.empty();\n\t\t\tthis.preview.append($('<img />').attr('src', this.selected_image.src).css('width', '100%').css('width', '100%'));\n\t\t\tthis.preview.css('background-color', 'inherit');\n\t\t}else{\n\t\t\tthis.preview.html(\"\");\n\t\t}\n\t}\n\n\t// Register the listen function to execute when this image is updated.\n\tonChange(func){\n\t\tthis.on_change = func;\n\t}\n}\n\n*/\n\n\n\n\n\n\n\n\n\n\n\n","import Draggable from '../util/draggable';\nimport Middleware from \"../middleware/middleware\";\nimport EntityLayer from \"./entities\";\nimport {boardTileHeight, boardTileWidth, imageHeightPx, imageWidthPx} from \"../consts\";\n\n\nexport class CanvasContainer {\n    private readonly base: HTMLDivElement;\n    private readonly wrapper: HTMLDivElement;\n    private readonly canvases: (Canvas|EntityLayer)[] = [];\n    private width: number;\n    private height: number;\n    private renderer: any;\n\n    constructor(width: number = 4800, height: number = 4800) {\n        this.width = width;\n        this.height = height;\n        this.base = document.createElement('div');\n        this.wrapper = document.createElement('div');\n        this.wrapper.className = 'canvasWrapper';\n        this.wrapper.style.backgroundColor = 'gray';\n        this.base.className = 'canvasBase';\n\n        this.base.prepend(this.wrapper);\n        document.body.prepend(this.base);\n        this.renderer = Draggable(this.wrapper, this.base);\n        this.setCanvasSize(width, height);\n        this.resetView();\n    }\n\n    public addLayer(canvas: Canvas|EntityLayer) {\n        this.canvases.push(canvas);\n        canvas.setSize(this.width, this.height);\n        canvas.appendTo(this.wrapper);\n    }\n\n    public addElement(object: HTMLElement) {\n        return this.wrapper.appendChild(object);\n    }\n\n    public removeElement(object: HTMLElement) {\n        return this.wrapper.removeChild(object);\n    }\n\n    public setCanvasSize(width: number, height: number) {\n        this.width = width;\n        this.height = height;\n        this.wrapper.style.width = `${this.width}px`;\n        this.wrapper.style.height = `${this.height}px`;\n        this.canvases.forEach(c => c.setSize(width, height));\n        this.resetView();\n    }\n\n    public resetView() {\n        this.renderer.panTo({\n            originX: this.width/2 * -1 + this.base.getBoundingClientRect().width/2,\n            originY: this.height/2 * -1 + this.base.getBoundingClientRect().height/2,\n            scale: 0.99\n        });\n    }\n\n    /**\n     * Convert the given screen pixel coords to the (nearest) Board tile (x,y) pair.\n     */\n    public screenToBoard(x: number, y: number) {\n        const rect = this.wrapper.getBoundingClientRect();\n        const scale = this.renderer.state.transformation.scale;\n\n        console.log('locating:', x, y, scale, rect);\n        const coords = {\n            x: Math.max(0, Math.min(boardTileWidth-1, Math.floor((x - rect.x) / scale / imageWidthPx))),\n            y: Math.max(0, Math.min(boardTileHeight-1, Math.floor((y - rect.y) / scale / imageHeightPx)))\n        };\n\n        console.log(coords);\n\n        return coords\n    }\n}\n\nexport class Canvas {\n    public readonly name: string;\n    protected readonly canvas: HTMLCanvasElement;\n    private readonly context: CanvasRenderingContext2D;\n\n    constructor(name: string) {\n        this.name = name;\n        this.canvas = document.createElement('canvas');\n        this.canvas.id = `canvas-${name}`;\n        this.canvas.className = 'canvasBackground';\n\n        // @ts-ignore\n        this.context = this.canvas.getContext('2d');\n        this.canvas.addEventListener('contextmenu', e => e.preventDefault());\n    }\n\n    public get ctx(): CanvasRenderingContext2D {\n        return this.context;\n    }\n\n    public get width(): number {\n        return this.canvas.width;\n    }\n\n    public get height(): number {\n        return this.canvas.height;\n    }\n\n    public setSize(width: number, height: number) {\n        this.canvas.width = width;\n        this.canvas.height = height;\n    }\n\n    public appendTo(ele: HTMLDivElement) {\n        ele.append(this.canvas);\n    }\n\n    public registerMiddleware(mdl: Middleware) {\n        mdl.attach(this.canvas);\n    }\n}\n","import Dexie from \"dexie\";\nimport {observable} from \"mobx\";\n\nexport const currentUsername = observable.box<string>('');\n\nenum Cats {\n    CERT = 'cert',\n    USER = 'user'\n}\n//TODO: More generic metadata system, for settings.\nclass MetaDB extends Dexie {\n    data: Dexie.Table<any, string>;\n\n    constructor() {\n        super(\"metadata\");\n\n        // Define tables and indexes\n        this.version(2).stores({\n            data: '&[catType+dexKey]'\n        });\n        this.data = this.table(\"data\");\n    }\n\n    public async get(catType: string, key: string): Promise<any> {\n        return JSON.parse((await this.data\n            .where({catType, dexKey: key})\n            .first())?.val || 'null');\n    }\n\n    public async getAll(catType: string): Promise<any[]> {\n        return (await this.data\n            .where({catType}).toArray())\n            .map(ob => JSON.parse(ob?.val))\n    }\n\n    public async store(catType: string, dexKey: string, val: any): Promise<string> {\n        return this.data.put({\n            catType,\n            val: JSON.stringify(val),\n            dexKey\n        });\n    }\n}\n\nconst db = new MetaDB();\n\nexport async function getCerts(): Promise<{ pubKey: any, privKey: any }> {\n    return {\n        pubKey: await db.get(Cats.CERT, 'cert-public'),\n        privKey: await db.get(Cats.CERT,'cert-private')\n    }\n}\n\nexport async function setCerts(pub: any, privateCert: any) {\n    await db.store(Cats.CERT, 'cert-public', pub);\n    await db.store(Cats.CERT, 'cert-private', privateCert);\n}\n\nexport async function setUsername(username: string) {\n    currentUsername.set(username);\n    return db.store(Cats.USER, 'username', username);\n}\n\nexport async function getUsername(): Promise<string> {\n    const res = await db.get(Cats.USER, 'username');\n    currentUsername.set(res);\n    return res;\n}\n\nexport async function setCurrentCampaign(campaign: number) {\n    return db.store(Cats.USER, 'campaign', campaign);\n}\n\nexport async function getCurrentCampaign(): Promise<number|null> {\n    return db.get(Cats.USER, 'campaign');\n}\n","import {Client} from \"../peerconnection\";\nimport ProtoWrapper from \"../../data/protobufs/proto-wrapper\";\n\nexport default abstract class Handler {\n    /** The type of packet this handler is listening for. */\n    public abstract readonly packets: typeof ProtoWrapper[];\n    private isHost: boolean = false;\n\n    setHost(isHost: boolean) {\n        this.isHost = isHost;\n    }\n\n    async handlePacket(client: Client, packet: ProtoWrapper) {\n        return this.isHost ? this.hostHandler(client, packet) : this.clientHandler(client, packet);\n    }\n\n    abstract async clientHandler(client: Client, packet: ProtoWrapper): Promise<void>;\n    abstract async hostHandler(client: Client, packet: ProtoWrapper): Promise<void>;\n}\n","import {getCerts, setCerts} from \"../db/metadata-db\";\nimport {observable} from \"mobx\";\n\nconst keyAlg = 'ECDSA';\nconst namedCurve = 'P-521'; //can be \"P-256\", \"P-384\", or \"P-521\"\nconst hashAlg = 'SHA-512';\nlet privateKey: CryptoKey|null = null;\nlet publicKey: CryptoKey|null = null;\nexport const roomID = observable.box<string|null>(null);\n\nfunction strToBuffer(text: string): ArrayBuffer {\n    let buf = new ArrayBuffer(text.length*2); // 2 bytes for each char\n    let bufView = new Uint16Array(buf);\n    for (let i=0, strLen=text.length; i < strLen; i++) {\n        bufView[i] = text.charCodeAt(i);\n    }\n    return buf\n}\n\nfunction bufferToStr (buffer: ArrayBuffer): string {\n    // @ts-ignore\n    return String.fromCharCode.apply(null, new Uint16Array(buffer));\n}\n\nexport async function hash(message: string) {\n    const hashBuffer = await crypto.subtle.digest(hashAlg, strToBuffer(message));\n    return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');\n}\n\n/**\n * Generate a sign/verify key. if they already exist in storage, use them instead.\n */\nexport async function initKeys(): Promise<void> {\n    const { pubKey, privKey } = await getCerts();\n    if (!pubKey || !privKey) {\n        await regenKeys();\n        console.debug('Generated new ID keys.');\n    } else {\n        publicKey = await hydrate(pubKey, [\"verify\"]);\n        privateKey = await hydrate(privKey, [\"sign\"]);\n        console.debug('Hydrated existing ID keys.');\n    }\n    await getMyRoomID();\n}\n\nexport async function regenKeys() {\n    const pair = await crypto.subtle.generateKey(\n        {\n            name: keyAlg,\n            namedCurve: namedCurve\n        },\n        true,\n        [\"sign\", \"verify\"]\n    );\n    privateKey = pair.privateKey;\n    publicKey = pair.publicKey;\n\n    const { privKey, pubKey } = await exportKeys();\n\n    await setCerts(pubKey, privKey);\n    await getMyRoomID();\n}\n\n/**\n * Load a CryptoKey object from a JSON token.\n * @param keyJSON\n * @param mode\n */\nasync function hydrate(keyJSON: string, mode:string [] = ['verify']): Promise<CryptoKey> {\n    return await crypto.subtle.importKey(\n        'jwk',\n        JSON.parse(keyJSON),\n        {\n            name: keyAlg,\n            namedCurve: namedCurve\n        },\n        true,\n        mode\n    );\n}\n\n/**\n * Create a savable object with the JSON-encoded public/private keys, as well as the derived room ID.\n *\n * Because the worst that could possibly happen is an impersonator forces you to use a new ID,\n * this room ID is greatly shortened - and thus technically less cryptographically secure.\n */\nexport async function exportKeys() {\n    if (!privateKey || !publicKey) throw Error('Keys not set!');\n    const privKey = JSON.stringify(await crypto.subtle.exportKey('jwk', privateKey));\n    const pubKey = JSON.stringify(await crypto.subtle.exportKey('jwk', publicKey));\n    const roomID = await hash(pubKey);\n\n    return {\n        roomID: roomID.substr(0, 20), // shorten key for URLs.\n        privKey,\n        pubKey\n    }\n}\n\n/**\n * Shortcut to get the room ID for the current public key.\n */\nexport async function getMyRoomID(): Promise<string> {\n    const rID = (await exportKeys()).roomID;\n    roomID.set(rID);\n    return rID;\n}\n\n/**\n * Sign the given message text.\n * @param message\n */\nexport async function sign(message: string): Promise<string> {\n    if (!privateKey) throw Error('No key set!');\n    const encoded = strToBuffer(message);\n\n    const signature = await window.crypto.subtle.sign(\n        {name: keyAlg, hash: {name: hashAlg}},\n        privateKey,\n        encoded\n    );\n\n    return bufferToStr(signature);\n}\n\nexport async function verify(key: CryptoKey, signature: string, message: string): Promise<boolean> {\n    let encoded = strToBuffer(message);\n\n    return await window.crypto.subtle.verify(\n        {name: keyAlg, hash: {name: hashAlg}},\n        key,\n        strToBuffer(signature),\n        encoded\n    );\n}\n\n/**\n * Signs the given object, appends the signature, then JSON-encodes the result.\n * @param {object} ob The object, signed JSON-encoded.\n */\nexport async function pack(ob: object): Promise<string> {\n    const sig = await sign(JSON.stringify(ob));\n\n    return JSON.stringify(\n        Object.assign({}, ob, {_sig: sig})\n    );\n}\n\n\n/**\n * JSON-decodes the given string, validates the signature for the new object,\n * then returns that object with the signature removed.\n *\n * Validates that the key hashes as expected against the room ID.\n * Raises an Error if the signature does not match.\n *\n * @param roomID\n * @param keyJSON\n * @param {string} objStr The JSON string that contains a signed object.\n */\nexport async function unpack(roomID: string, keyJSON: string, objStr: string): Promise<any> {\n    const hashStr = await hash(keyJSON);\n\n    if (!keyJSON) throw Error('Missing key - cannot be empty.');\n    if (roomID.length < 8) throw Error('roomID was empty, cannot set public key.');\n    if (hashStr.indexOf(roomID) !== 0) throw Error('The given key is not valid for this room! Impostor host?');\n\n    const key = await hydrate(keyJSON);\n\n    const ob = JSON.parse(objStr);\n    const sig = ob._sig;\n\n    delete ob._sig;\n\n    if (! await verify(key, sig, JSON.stringify(ob))) {\n        throw Error('Invalid signature for object!')\n    }\n\n    return ob;\n}\n","import {TerrainAddPacket, TerrainErasePacket} from \"./terrainPackets\";\nimport ProtoWrapper from \"../../data/protobufs/proto-wrapper\";\nimport {ProtoBoard, ProtoTileStack} from \"../../data/protobufs/proto-tiles\";\nimport {EntityDeletePacket, EntityUpdatePacket} from \"./entityPackets\";\nimport {PingPacket, ReadyPacket, SignaturePacket} from \"./util-packets\";\n\nexport const packetList: typeof ProtoWrapper[] = [\n    SignaturePacket,\n    ReadyPacket,\n    TerrainErasePacket,\n    TerrainAddPacket,\n    ProtoBoard,\n    ProtoTileStack,\n    EntityUpdatePacket,\n    EntityDeletePacket,\n    PingPacket\n];\n\nexport const packetMap: Record<string, number> = {};\n\nfor (let i=0; i<packetList.length; i++) {\n    packetMap[packetList[i].name] = i;\n}\n","import { useSnackbar, WithSnackbarProps, OptionsObject } from 'notistack'\nimport React from 'react'\n\nlet snackbarRef: WithSnackbarProps;\n\n\nexport const SnackbarUtilsConfigurator: React.FC = () => {\n    snackbarRef = useSnackbar();\n    return null;\n};\n\nexport default {\n    success(msg: string, options: OptionsObject = {}) {\n        this.toast(msg, { ...options, variant: 'success' })\n    },\n    warning(msg: string, options: OptionsObject = {}) {\n        this.toast(msg, { ...options, variant: 'warning' })\n    },\n    info(msg: string, options: OptionsObject = {}) {\n        this.toast(msg, { ...options, variant: 'info' })\n    },\n    error(msg: string, options: OptionsObject = {}) {\n        this.toast(msg, { ...options, variant: 'error' })\n    },\n    toast(msg: string, options: OptionsObject = {}) {\n        snackbarRef.enqueueSnackbar(msg, options)\n    }\n}\n","import {Message} from \"protobufjs/light\";\n\n/**\n * Wrapper for protobuf Message, which allows quick & typed constructor unpacking.\n */\nexport default class ProtoWrapper<T extends object = object> extends Message<T>{\n    /**\n     * Shortcut to assign the given values to this object, then return it.\n     */\n    assign(values: Partial<this>): this {\n        return Object.assign(this, values)\n    }\n}\n","import {Field, Type} from \"protobufjs/light\";\nimport ProtoWrapper from \"./proto-wrapper\";\n\n@Type.d(\"ProtoSprite\")\nexport class ProtoSprite extends ProtoWrapper<ProtoSprite> {\n    @Field.d(1, \"string\", \"required\", \"\")\n    public id: string = '';\n\n    @Field.d(2, \"int32\", \"required\", 0)  // Use \"sint32\" if idx will be negative often.\n    public idx: number = 0;\n}\n","import {Field, Type} from \"protobufjs/light\";\nimport ProtoWrapper from \"./proto-wrapper\";\nimport {ProtoSprite} from \"./proto-sprite\";\nimport {Entity} from \"../../controllers/entities\";\n\n@Type.d(\"ProtoEntity\")\nexport class ProtoEntity extends ProtoWrapper<ProtoEntity> {\n    @Field.d(1, ProtoSprite, \"required\")\n    public sprite: ProtoSprite = new ProtoSprite();\n\n    @Field.d(2, 'int32', \"required\")\n    public x: number = 0;\n\n    @Field.d(3, 'int32', \"required\")\n    public y: number = 0;\n\n    @Field.d(4, 'bool', \"required\")\n    public visible: boolean = false;\n\n    @Field.d(5, 'string', \"required\")\n    public color: string = '';\n\n    @Field.d(6, 'string', \"required\")\n    public id: string = '';\n\n    @Field.d(7, 'string', \"repeated\")\n    public owners: string[] = [];\n\n    @Field.d(8, 'bool', \"required\")\n    public saveToCampaign: boolean = false;\n\n    @Field.d(9, 'string', \"required\")\n    public name: string = '';\n\n    public static fromEntity(entity: Entity) {\n        const sprite = new ProtoSprite().assign({id: entity.sprite.id, idx: entity.sprite.idx})\n        return new ProtoEntity().assign({\n            ...entity,\n            sprite,\n            owners: Array.from(entity.owners)\n        });\n    }\n}\n","import {Field, Type} from \"protobufjs/light\";\nimport ProtoWrapper from './proto-wrapper';\nimport {ProtoSprite} from \"./proto-sprite\";\nimport {ProtoEntity} from \"./proto-entity\";\n\n\n@Type.d(\"ProtoTile\")\nexport class ProtoTile extends ProtoWrapper<ProtoTile> {\n    @Field.d(1, \"int32\", \"required\", 0)\n    public x: number = 0;\n\n    @Field.d(2, \"int32\", \"required\", 0)\n    public y: number = 0;\n\n    @Field.d(3, \"int32\", \"required\", 0)\n    public z: number = 0;\n\n    @Field.d(4, \"int32\", \"required\", 0)\n    public spriteIdx: number = 0;\n}\n\n@Type.d(\"ProtoTileStack\")\nexport class ProtoTileStack extends ProtoWrapper<ProtoBoard> {\n    @Field.d(1, ProtoTile, \"repeated\")\n    public tiles: ProtoTile[] = [];\n\n    @Field.d(2, ProtoSprite, \"repeated\")\n    public sprites: ProtoSprite[] = [];\n}\n\n\n@Type.d(\"ProtoBoard\")\nexport class ProtoBoard extends ProtoWrapper<ProtoBoard> {\n    @Field.d(1, ProtoTileStack, \"required\")\n    public terrain: ProtoTileStack|null = null;\n    @Field.d(2, ProtoEntity, \"repeated\")\n    public entities: ProtoEntity[] = [];\n}\n","import {Field, Type} from \"protobufjs/light\";\nimport ProtoWrapper from \"../../data/protobufs/proto-wrapper\";\nimport {ProtoTileStack} from \"../../data/protobufs/proto-tiles\";\n\n@Type.d(\"TerrainAddPacket\")\nexport class TerrainAddPacket extends ProtoWrapper<TerrainAddPacket> {\n    @Field.d(1, ProtoTileStack, \"repeated\")\n    public tileStacks: ProtoTileStack[] = [];\n}\n\n@Type.d(\"TerrainCoordPacket\")\nexport class TerrainCoordPacket extends ProtoWrapper<TerrainCoordPacket> {\n    @Field.d(1, 'int32', \"required\")\n    public x: number = 0;\n    @Field.d(2, 'int32', \"required\")\n    public y: number = 0;\n}\n\n@Type.d(\"TerrainErasePacket\")\nexport class TerrainErasePacket extends ProtoWrapper<TerrainErasePacket> {\n    @Field.d(1, TerrainCoordPacket, \"repeated\")\n    public coords: TerrainCoordPacket[] = [];\n}\n","import {Field, Type} from \"protobufjs/light\";\nimport ProtoWrapper from \"../../data/protobufs/proto-wrapper\";\nimport {ProtoEntity} from \"../../data/protobufs/proto-entity\";\n\n\n@Type.d(\"EntityUpdatePacket\")\nexport class EntityUpdatePacket extends ProtoWrapper<EntityUpdatePacket> {\n    @Field.d(1, ProtoEntity, \"repeated\")\n    public entities: ProtoEntity[] = [];\n}\n\n\n@Type.d(\"EntityDeletePacket\")\nexport class EntityDeletePacket extends ProtoWrapper<EntityDeletePacket> {\n    @Field.d(1, 'string', \"required\")\n    public entityID: string = '';\n}\n","import {Field, Type} from \"protobufjs/light\";\nimport ProtoWrapper from \"../../data/protobufs/proto-wrapper\";\n\n@Type.d(\"PingPacket\")\nexport class PingPacket extends ProtoWrapper<PingPacket> {}\n\n@Type.d(\"SignaturePacket\")\nexport class SignaturePacket extends ProtoWrapper<SignaturePacket> {\n    @Field.d(1, \"string\", \"required\", 'def')\n    public signedJSON: string = '';\n}\n\n@Type.d(\"ReadyPacket\")\nexport class ReadyPacket extends ProtoWrapper<ReadyPacket> {}\n","import * as worker from './messageEncoder.worker';\nimport { packetList, packetMap } from \"./packets/packet-list\";\n\n/**\n * Use a Web Worker thread to encode the given ProtoWrapper object into a compressed binary buffer.\n * @param packet\n */\nexport async function encode(packet: any): Promise<Uint8Array> {\n    const id = packetMap[packet.constructor.name];\n    const clazz = packetList[id];\n\n    if (!clazz) throw Error(`Error encoding packet: Unknown type: \"${packet.constructor.name}\"!`)\n\n    return await worker.workerEncode(packet, id)\n}\n\n/**\n * Use a Web Worker thread to decompress a binary buffer into a ProtoWrapper object, properly cast to the correct subclass.\n * @param data\n */\nexport async function decode(data: Uint8Array): Promise<any> {\n    const id = data.slice(0,1)[0];\n    const clazz = packetList[id];\n\n    if (!clazz) throw Error(`Error decoding packet: Unknown ID: [${id}], (${data.length})!`);\n\n    return new clazz().assign(await worker.workerDecode(data));\n}\n","import Peer, {DataConnection} from 'peerjs';\nimport {getMyRoomID} from './crypter'\nimport Handler from \"./handlers/handler\";\nimport {IObservableValue, observable, ObservableSet} from \"mobx\";\nimport notifications from \"../../ui-components/notifications\";\nimport * as encoder from './messageEncoder';\nimport ProtoWrapper from \"../data/protobufs/proto-wrapper\";\nimport PromiseStream from \"../util/promiseStream\";\nimport {PreCheck} from \"./prechecks/precheck\";\nimport {UserData} from \"../db/user-db\";\nimport {PingPacket} from \"./packets/util-packets\";\n\nexport enum NetworkStatus {\n    IDLE,\n    CONNECTED,\n    CONNECTING,\n    RECONNECTING,\n    DISCONNECTED,\n    MATCHMAKING,\n    MATCHMAKING_FAIL,\n    WAITING_FOR_HOST\n}\n\nexport enum NetworkMode {\n    UNKNOWN,\n    HOST,\n    CLIENT,\n}\n\nlet handlers: Handler[] = [];\nlet preConn: PreCheck[] = [];\n\n\n\nexport const clients: ObservableSet<Client> = observable(new Set<Client>());\n\nlet _peer: Peer | null = null;\nexport let roomID: IObservableValue<string> = observable.box('');\nexport let netStatus: IObservableValue<NetworkStatus> = observable.box(NetworkStatus.IDLE);\nexport let netMode: IObservableValue<NetworkMode> = observable.box(NetworkMode.UNKNOWN);\n\nexport function setHandlers(newHandlers: Handler[], newPreConn: PreCheck[]) {\n    handlers = newHandlers;\n    preConn = newPreConn\n}\n\nexport async function peer(makeNew: boolean = false): Promise<Peer> {\n    if (_peer){\n        if (makeNew) {\n            _peer.destroy()\n            _peer = null;\n        } else {\n            return _peer;\n        }\n    }\n\n    roomID.set(await getMyRoomID());\n\n    netStatus.set(NetworkStatus.MATCHMAKING);\n\n    _peer = new Peer(roomID.get(), {\n        host: 'peerjs.rofl.wtf', // Relative path assumes current hostname.\n        port: 443,\n        path: '/',\n        key: 'gaia-password',\n        secure: true\n    });\n\n    await new Promise((res, rej) => {\n        // Wait for the peer server connection to be ready.\n        // @ts-ignore\n        _peer.on('open', res);\n        // @ts-ignore\n        _peer.on('error', (err: any) => {\n            console.error(`PeerJS Error:`, err);\n            notifications.error(`PeerJS Error: ${err.message}`, {preventDuplicate: true, autoHideDuration: 10000})\n            netStatus.set(NetworkStatus.MATCHMAKING_FAIL);\n            rej(err);\n        });\n    });\n\n    return _peer;\n}\n\nexport async function connectTo(roomID: string): Promise<any> {\n    await setMode(NetworkMode.CLIENT);\n    if (netStatus.get() !== NetworkStatus.RECONNECTING) netStatus.set(NetworkStatus.CONNECTING);\n    const p = await peer(true);\n\n    let conn: DataConnection;\n    let client: Client;\n\n    conn = p.connect(roomID, {\n        reliable: true\n    });\n    client = new Client(conn, handlers, roomID);\n    client.shouldReconnect = true;\n\n    conn.on('close', () => clientError('host disconnected', client));\n    conn.on('error', (err: any) => clientError(err, client));\n    conn.on('open', () => {\n        notifications.success('Connected to host!');\n        console.log('CONNECTED TO HOST!');\n    });\n\n    try {\n        netStatus.set(NetworkStatus.WAITING_FOR_HOST);\n        for (const pc of preConn) {\n            await pc.run(false, client);\n            console.debug('Finished pre-check:', pc.constructor.name);\n        }\n        client.verified = true;\n        clients.add(client);\n        netStatus.set(NetworkStatus.CONNECTED);\n    } catch (err) {\n        console.error('failed validation', err);\n        client.shouldReconnect = false;\n        await clientError(err, client)\n    }\n}\n\nexport async function clientError(err: any, client: Client): Promise<any> {\n    console.warn('Client Error:', err, client.shouldReconnect);\n    removeClient(client);\n    client.close();\n\n    netStatus.set(NetworkStatus.DISCONNECTED);\n\n    if (client.shouldReconnect) {\n        console.log('Reconnecting...');\n        netStatus.set(NetworkStatus.RECONNECTING);\n        return connectTo(client.roomID)\n    }\n}\n\nexport async function openHost() {\n    await setMode(NetworkMode.HOST);\n\n    const server = await peer(true);\n\n    netStatus.set(NetworkStatus.CONNECTED);\n\n    server.on('connection', (conn: DataConnection) => {\n        let cli: Client|null = null;\n        console.warn('Client connected!')\n        conn.on('open', async () => {\n            cli = new Client(conn, handlers, roomID.get());\n            try{\n                for (const pc of preConn) {\n                    await pc.run(true, cli);\n                    console.debug('Finished pre-check:', pc.constructor.name);\n                }\n                cli.verified = true;\n                clients.add(cli);\n            } catch (err) {\n                console.error(err);\n                cli.close();\n            }\n        });\n        conn.on('close', () => {\n            if (cli) {\n                console.debug('Client dropped:', cli);\n                removeClient(cli);\n            }\n        });\n    });\n}\n\nexport async function kill(): Promise<void> {\n    if (_peer) {\n        clients.forEach(p => {\n            p.close();\n            removeClient(p);\n        });\n        netMode.set(NetworkMode.UNKNOWN);\n        netStatus.set(NetworkStatus.IDLE);\n        await _peer.destroy();\n        _peer = null;\n    }\n}\n\n/**\n * Destroy the connection and set the new mode.\n * @param mode\n */\nasync function setMode(mode: NetworkMode) {\n    await kill();\n    netMode.set(mode);\n}\n\nfunction removeClient(client: Client) {\n    clients.delete(client);\n}\n\n\nexport class Client {\n    private conn: DataConnection;\n    private listener: Function|null = null;\n    public readonly roomID: string;\n    private readonly handlers: Handler[];\n    public verified: boolean = false;\n    public shouldReconnect: boolean = false;\n    private lastSend = Promise.resolve();\n    private stream = new PromiseStream();\n    public userData: UserData = {id: -1, username: 'null', keyCodes:[], lastSeen: 0};\n    private readonly pingTimer: any = null;\n    public lastPing: number = 0;\n\n    constructor(conn: DataConnection, handlers: Handler[], roomID: string) {\n        this.conn = conn;\n        this.roomID = roomID;\n        this.handlers = handlers;\n        this.hook();\n\n        this.pingTimer = setInterval(() => {\n            if (!this.verified) return;\n            if (!this.conn.open) return this.close();\n            if (!this.lastPing) {\n                this.lastPing = Date.now();\n                return;\n            } else if (Date.now() - this.lastPing > 15000) {\n                console.warn('Ping timeout.')\n                return this.close();\n            }\n            this.send(new PingPacket()).then();\n        }, 10000)\n    }\n\n    hook() {\n        const self = this;\n        this.conn.on('data', data => {\n            self.stream.queue(() => self.handleMessage(data), ()=>this.conn.close())\n        });\n        this.conn.on('error', (err) => {\n            console.error('Client error:', err);\n            this.conn.close();\n        });\n    }\n\n    async handleMessage(packetBinary: ArrayBuffer) {\n        try {\n            const packet: ProtoWrapper = await encoder.decode(new Uint8Array(packetBinary));\n            if (this.listener) {\n                this.listener(packet);\n            } else if (!this.verified) {\n                // noinspection ExceptionCaughtLocallyJS\n                throw Error(`Error: Unexpected packet sent before verification: ${packet}`);\n            } else {\n                console.debug('Incoming Packet:', packet);\n                for (const h of this.handlers) {\n                    // @ts-ignore\n                    if (h.packets.some(p => packet.$type === p.$type)) {\n                        return await h.handlePacket(this, packet);\n                    }\n                }\n            }\n        } catch (err) {\n            console.error(err);\n            this.shouldReconnect = false;\n            this.close();\n        }\n    }\n\n    close() {\n        if (this.listener) {\n            this.shouldReconnect = false;\n            this.listener(null);\n        }\n        if (this.pingTimer) clearTimeout(this.pingTimer);\n\n        this.conn.close();\n    }\n\n    /**\n     * Sends the given Packet to the client.\n     * Utilizes an internal \"rolling Promise\" to assure that all messages are sent in order.\n     * @param packet\n     */\n    async send(packet: ProtoWrapper) {\n        console.debug('Sending client:', packet);\n        this.lastSend = this.lastSend.then(async () => {\n            this.sendBuffer(await encoder.encode(packet));\n        }).catch(err => {\n           console.error(`Error sending message to client:`, err);\n        });\n    }\n\n    sendBuffer(data: Uint8Array) {\n        this.conn.send(data);\n    }\n\n    /**\n     * Wait for the next packet, whatever it may be.\n     * Only one listener may be waiting at any given time, or an error will be thrown on subsequent registrations.\n     * @param expectedType\n     */\n    getNextPacket(expectedType: any): Promise<any> {\n        if (this.listener) throw Error('Attempted to overwrite client listener!');\n\n        return new Promise((res, rej) => {\n            this.listener = (packet: any) => {\n                this.listener = null;\n                if (!(packet instanceof expectedType)) {\n                    return rej(`Unexpected packet type: ${packet} !== ${expectedType}`)\n                }\n                return res(packet);\n            }\n        });\n    }\n}\n\n/**\n * Broadcast the given data to all connected connections.\n * If `requireHost` is true, will only send while we are hosting.\n * @param packet\n * @param requireHost\n */\nexport async function broadcast(packet: ProtoWrapper, requireHost: boolean) {\n    if (requireHost && netMode.get() !== NetworkMode.HOST) {\n        return;\n    }\n    const data = await encoder.encode(packet)\n\n    clients.forEach(c => c.sendBuffer(data));\n}\n\nexport function isHost() {\n    return netMode.get() === NetworkMode.HOST\n}\n","/**\n * Chain promises sequentially, with a maximum stack size.\n */\nexport default class PromiseStream {\n    private prom: Promise<any> = Promise.resolve();\n    private readonly maxBackpressure: number;\n    private backPressure: number = 0;\n\n    constructor(maxBackpressure: number = 0) {\n        this.maxBackpressure = maxBackpressure\n    }\n\n    get length() {\n        return this.backPressure;\n    }\n\n    public queue(fn: Function, onError: Function|null = null) {\n        if (this.maxBackpressure && this.backPressure >= this.maxBackpressure) {\n            throw Error('Max backpressure reached!')\n        }\n        this.backPressure++;\n\n        this.prom = this.prom.then( async () => {\n            await fn();\n        }).catch( async err => {\n            if (onError) {\n                await onError(err);\n            } else {\n                console.error(err);\n            }\n        }).then(() => {\n            this.backPressure--;\n        })\n    }\n}\n","import {Sprite} from \"../../util/sprite-loading\";\n\nexport class Tile {\n    public x: number = 0;\n    public y: number = 0;\n    public z: number = 0;\n    public sprite: Sprite;\n\n    constructor(sprite: Sprite) {\n        this.sprite = sprite;\n    }\n}\n","import Handler from \"./handler\";\nimport {broadcast, Client, isHost} from \"../peerconnection\";\nimport Terrain from \"../../controllers/terrain\";\nimport {Sprite} from \"../../util/sprite-loading\";\nimport {ProtoTileStack} from \"../../data/protobufs/proto-tiles\";\nimport ProtoWrapper from \"../../data/protobufs/proto-wrapper\";\nimport * as packer from '../../data/board-packer.worker';\nimport {TerrainAddPacket} from \"../packets/terrainPackets\";\nimport {Tile} from \"../../data/interfaces/tile\";\n\n\nexport default class TerrainAddHandler extends Handler {\n    private static tiles: Tile[][] = [];\n    readonly packets: typeof ProtoWrapper[] = [TerrainAddPacket];\n    private readonly terrain: Terrain;\n\n    constructor(terrain: Terrain) {\n        super();\n        this.terrain = terrain;\n    }\n\n    static pollChanges() {\n        setTimeout(async () => {\n            await TerrainAddHandler.broadcastChanges();\n            TerrainAddHandler.pollChanges()\n        }, 200);\n    }\n\n    async clientHandler(client: Client, packet: TerrainAddPacket): Promise<void> {\n        for (const data of packet.tileStacks) {\n            if (!data) return;\n            const stack = data.tiles;\n\n            if (stack.length) {\n                this.terrain.removeAt(stack[0].x, stack[0].y, false);\n                for (let i=0; i < stack.length; i++) {\n                    const dt = stack[i];\n                    const sp = data.sprites[dt.spriteIdx];\n                    const t = new Tile(new Sprite(sp.id, sp.idx));\n                    this.terrain.placeAt(dt.x, dt.y, t, i === stack.length-1, false);\n                }\n            }\n        }\n    }\n\n    async hostHandler(client: Client, packet: any): Promise<void> {\n        throw Error('Client sent host new Terrain data. Not allowed.')\n    }\n\n    static async broadcastChanges() {\n        if (TerrainAddHandler.tiles.length) {\n            const packedStacks: ProtoTileStack[] = []\n            const updateTiles = TerrainAddHandler.tiles.splice(0, TerrainAddHandler.tiles.length);\n\n            for (const t of updateTiles) {\n                packedStacks.push(await packer.packTiles(t));\n            }\n\n            await broadcast(new TerrainAddPacket().assign({\n                tileStacks: packedStacks\n            }), true);\n        }\n    }\n\n    static sendTerrainAdd(tiles: Tile[]) {\n        if (isHost()) TerrainAddHandler.tiles.push(tiles);\n    }\n}\n\nTerrainAddHandler.pollChanges();\n","import Handler from \"./handler\";\nimport {broadcast, Client, isHost} from \"../peerconnection\";\nimport Terrain from \"../../controllers/terrain\";\nimport ProtoWrapper from \"../../data/protobufs/proto-wrapper\";\nimport {TerrainCoordPacket, TerrainErasePacket} from \"../packets/terrainPackets\";\n\nexport default class TerrainEraseHandler extends Handler {\n    private static tiles: Set<TerrainCoordPacket> = new Set();\n    readonly packets: typeof ProtoWrapper[] = [TerrainErasePacket];\n    private readonly terrain: Terrain;\n\n    constructor(terrain: Terrain) {\n        super();\n        this.terrain = terrain;\n    }\n\n    static pollChanges() {\n        setTimeout(async () => {\n            await TerrainEraseHandler.broadcastChanges();\n            TerrainEraseHandler.pollChanges()\n        }, 200);\n    }\n\n    async clientHandler(client: Client, packet: TerrainErasePacket): Promise<void> {\n        for (const t of packet.coords) {\n            this.terrain.removeAt(t.x, t.y, true);\n        }\n    }\n\n    async hostHandler(client: Client, packet: ProtoWrapper): Promise<void> {\n        throw Error('Client attempted to erase terrain. Not allowed.')\n    }\n\n    /**\n     * Batches the removed terrain coords, to be sent shortly after.\n     * @param x\n     * @param y\n     */\n    static sendTerrainRemove(x: number, y: number) {\n        if (isHost()) TerrainEraseHandler.tiles.add(new TerrainCoordPacket().assign({ x, y}));\n    }\n\n    /**\n     * Sends all the batched changes. Runs on a loop. Can be called manually to instantly send all changes.\n     */\n    static async broadcastChanges() {\n        if (TerrainEraseHandler.tiles.size) {\n            const tep  = new TerrainErasePacket().assign({\n                coords: Array.from(TerrainEraseHandler.tiles)\n            });\n            TerrainEraseHandler.tiles.clear();\n            await broadcast(tep, true);\n        }\n    }\n}\n\nTerrainEraseHandler.pollChanges();\n","import {Canvas} from \"./canvas\";\nimport {Sprite} from \"../util/sprite-loading\";\nimport {imageHeightPx, imageWidthPx} from \"../consts\";\nimport {observable} from \"mobx\";\nimport TerrainAddHandler from \"../net/handlers/terrain-add-handler\";\nimport TerrainEraseHandler from \"../net/handlers/terrain-erase-handler\";\nimport {ProtoBoard} from \"../data/protobufs/proto-tiles\";\nimport {Tile} from \"../data/interfaces/tile\";\n\n\nexport default class Terrain extends Canvas {\n    private readonly terrain: Record<string, Tile[]> = {};\n    public boardWidth: number = 0;\n    public boardHeight: number = 0;\n    public tileIDX: number = 0; // Simple counter to track terrain in the order they were placed.\n    @observable public selectedSprite: Sprite | null = null;\n    @observable public isBoardDirty: boolean = false;\n\n    constructor(width: number, height: number) {\n        super('terrain');\n        this.resizeBoard(width, height);\n    }\n\n    public resizeBoard(width: number, height: number) {\n        this.boardWidth = width;\n        this.boardHeight = height;\n        for (const tList of Object.values(this.terrain)) {\n            const x = tList[0].x;\n            const y = tList[0].y;\n            if (x > this.boardWidth || y > this.boardHeight) {\n                this.removeAt(x, y);\n            }\n        }\n    }\n\n    /**  Derive new tile widthxheight whenever this canvas is resized. */\n    public setSize(width: number, height: number) {\n        super.setSize(width, height);\n        this.resizeBoard(Math.floor(width/imageWidthPx), Math.floor(height/imageHeightPx));\n    }\n\n    public removeAt(x: number, y: number, redraw: boolean = true): boolean {\n        const exists = this.terrain[Terrain.mkKey(x, y)]?.length;\n        if (exists) {\n            delete this.terrain[Terrain.mkKey(x, y)];\n            if (redraw) this.redrawAt(x, y);\n        }\n        return !!exists;\n    }\n\n    /**\n     * Same as removeAt, but send events to clients.\n     * @param x\n     * @param y\n     */\n    public eraseAt(x: number, y: number) {\n        if (this.removeAt(x, y, true)) {\n            TerrainEraseHandler.sendTerrainRemove(x, y);\n            if (!this.isBoardDirty) this.isBoardDirty = true;\n        }\n    }\n\n    /**\n     * Place the given Tile at the given coords, optionally skipping redrawing.\n     * This method is smart, and auto-handles tile overlay logic.\n     * @param x\n     * @param y\n     * @param tile\n     * @param redraw\n     * @param broadcast\n     */\n    public placeAt(x: number, y: number, tile: Tile, redraw: boolean = true, broadcast: boolean = false): boolean {\n        const existing = this.getAt(x, y);\n        if (existing.length && existing[existing.length-1].sprite.composite === tile.sprite.composite) {\n            // The given sprite is already at the top of the stack; Skip adding because it won't do anything.\n            return false;\n        }\n        if (tile.sprite.isBlocker) {\n            this.removeAt(x, y, false);\n        }\n        const k = Terrain.mkKey(x, y);\n        this.terrain[k] = this.terrain[k]?.filter(t => t.sprite.composite !== tile.sprite.composite) || [];  // Filter duplicates.\n        this.terrain[k].push(tile);\n        tile.x = x;\n        tile.y = y;\n        tile.z = this.tileIDX++;\n        if (redraw) this.redrawAt(x, y);\n        if (broadcast) TerrainAddHandler.sendTerrainAdd(this.terrain[k]);\n        if (!this.isBoardDirty) this.isBoardDirty = true;\n        return true;\n    }\n\n    /**\n     * Draw the currently-selected sprite onto the given coords.\n     * @param x\n     * @param y\n     */\n    public drawAt(x: number, y: number): boolean {\n        if (x < 0 || x >= this.boardWidth || y < 0 || y >= this.boardHeight) {\n            return false;\n        }\n        if (this.selectedSprite) {\n            return this.placeAt(x, y, new Tile(this.selectedSprite), true, true);\n        }\n        return false;\n    }\n\n    public getAt(x: number, y: number): Tile[] {\n        return this.terrain[Terrain.mkKey(x, y)] || [];\n    }\n\n    private redrawAt(x: number, y: number) {\n        const tiles = this.getAt(x, y);\n        const covered = tiles.some(t => t.sprite.isBlocker);\n        const px = x * imageWidthPx;\n        const py = y * imageHeightPx;\n        if (!covered || !tiles.length) {\n            this.ctx.clearRect(px, py, imageWidthPx, imageHeightPx);\n        }\n        tiles.map(t => t.sprite.drawTo(this.ctx, px, py));\n    }\n\n    /**\n     * Directly export the underlying terrain map, for serialization.\n     */\n    getDirectMap() {\n        return this.terrain;\n    }\n\n    /**\n     * Import a serialized tile map, over the current data.\n     * @param newTerrain\n     */\n    setDirectMap(newTerrain: ProtoBoard) {\n        if (!newTerrain.terrain) throw Error('Malformed packet.')\n        for (const k of Object.keys(this.terrain)) {\n            const t = this.terrain[k][0];\n            this.removeAt(t.x, t.y, true);\n        }\n\n        for (const k of newTerrain.terrain.tiles.sort((a, b) => a.z - b.z)) {\n            const sp = newTerrain.terrain.sprites[k.spriteIdx];\n            this.placeAt(k.x, k.y, new Tile(new Sprite(sp.id, sp.idx)), false, false);\n        }\n        for (const k of Object.keys(this.terrain)) {\n            this.redrawAt(this.terrain[k][0].x, this.terrain[k][0].y)\n        }\n    }\n\n    private static mkKey(x: number, y: number): string {\n        return `${x},${y}`;\n    }\n}\n","\nexport default abstract class Middleware {\n    private ele: HTMLElement|null = null;\n    private hooks: any[] = [];\n\n    public eject() {\n        this.hooks.forEach(h => h());\n        this.onCleanup();\n        this.ele = null;\n    }\n\n    public attach(ele: HTMLElement) {\n        this.ele = ele;\n        this.register();\n    }\n\n    /** Attach an event listener that is automatically cleaned up when this middleware is ejected.\n     * The `cb` callback should return `true` if the event should stop here. */\n    protected listen(event: string, cb: any, target?: HTMLElement|Window): Function {\n        const wrapped = (event: Event) => {\n            const res = cb(event);\n            if (res) {\n                event.stopPropagation();\n                event.preventDefault();\n            }\n            return res;\n        };\n        const trg = target || this.ele;\n        const rem = () => trg?.removeEventListener(event, wrapped);\n        trg?.addEventListener(event, wrapped);\n        this.hooks.push(rem);\n        return rem;\n    }\n\n    /** Called once an element is registered and ready to call `listen()`. */\n    protected abstract register(): void;\n    /** Called after all hooks have been cleaned up. */\n    protected abstract onCleanup(): void;\n}\n","import Middleware from \"./middleware\";\nimport {imageHeightPx, imageWidthPx} from \"../consts\";\nimport EntityLayer, {EntityEle} from \"../controllers/entities\";\n\ninterface Point {\n    x: number;\n    y: number;\n}\n\nexport default class EntityMiddleware extends Middleware {\n    private ent: EntityEle|null = null;\n    private readonly container: HTMLElement;\n    private moveListener: Function|null = null;\n    private movePoints: Point[] = [];\n    private moveTrackers: HTMLElement[] = [];\n    private entityLayer: EntityLayer;\n\n    constructor(container: HTMLElement, entLayer: EntityLayer) {\n        super();\n        this.container = container;\n        this.entityLayer = entLayer;\n    }\n\n    public setTarget(entEle: EntityEle|null) {\n        this.ent = entEle;\n        this.clearMover();\n        if (this.ent) {\n            this.entityLayer.toggleInput(false);\n            this.ent.bringToFront();\n            this.moveListener = this.listen('pointermove', (ev: PointerEvent) => {\n                const [x, y] = EntityMiddleware.toGrid(ev);\n                this.addPoint(x, y);\n                return true;\n            }, this.container);\n        }\n    }\n\n    register(): void {\n        this.listen('pointerup', (ev: PointerEvent) => {\n            if (this.moveListener) {\n                this.entityLayer.toggleInput(true);\n                return this.clearMover();\n            }\n        }, window);\n    }\n\n    private clearMover(): boolean {\n        this.moveTrackers.forEach(mp => mp.remove());\n        this.moveTrackers = [];\n        this.movePoints = [];\n        if (this.moveListener) {\n            this.moveListener();\n            this.moveListener = null;\n            return true;\n        }\n        return false;\n    }\n\n    private addPoint(x: number, y: number) {\n        const last = this.movePoints[this.movePoints.length-1];\n        if (last && last.x === x && last.y === y) return;\n\n        const idx = this.movePoints.findIndex(p => p.x === x && p.y === y);\n        if (idx >=0) {\n            this.movePoints.splice(idx, this.movePoints.length);\n        }\n        this.movePoints.push({x, y});\n        this.checkDiag();\n        this.redrawPath();\n        if (this.ent) {\n            this.entityLayer.updateEntity(this.ent.entity.id,{x, y});\n        }\n    }\n\n    private checkDiag() {\n        if (this.movePoints.length < 3) return;\n        const last = this.movePoints[this.movePoints.length - 1];\n        const third = this.movePoints[this.movePoints.length - 3];\n        const dist = EntityMiddleware.distance(third, last);\n\n        if (dist < 2) {\n            // Corner we can cut!\n            this.movePoints.splice(this.movePoints.length-2, 1);\n        }\n    }\n\n    private static distance(p1: Point, p2: Point) {\n        return Math.sqrt(Math.pow(p1.x-p2.x, 2) + Math.pow(p1.y - p2.y, 2));\n    }\n\n    private pathLength(): number {\n        let val = 0;\n        this.movePoints.reduce((prev, next) => {\n            let dst = EntityMiddleware.distance(prev, next);\n            if (dst > 1) dst = 1.5;\n            val += dst;\n            return next;\n        })\n\n        return Math.floor(val);\n    }\n\n    private redrawPath() {\n        this.moveTrackers.forEach(mp => mp.remove());\n        this.moveTrackers = [];\n\n        let id = 0;\n\n        for (const p of this.movePoints) {\n            const ele = document.createElement('div');\n            ele.className = 'entityMoveTracker';\n            Object.assign(ele.style, {\n                width: `${imageWidthPx}px`,\n                height: `${imageHeightPx}px`,\n                left: `${p.x*imageWidthPx}px`,\n                top: `${p.y*imageHeightPx}px`\n            });\n            if (++id === this.movePoints.length) {\n                ele.innerText = `${this.pathLength()*5}`;\n            }\n            this.moveTrackers.push(ele);\n            this.container.prepend(ele);\n        }\n    }\n\n    private static toGrid(ev: any) {\n        const x = Math.floor(ev.offsetX/imageWidthPx);\n        const y = Math.floor(ev.offsetY/imageHeightPx);\n        return [x, y]\n    }\n\n    protected onCleanup(): void {\n        this.clearMover();\n    }\n}\n","import Handler from \"./handler\";\nimport {broadcast, Client} from \"../peerconnection\";\nimport ProtoWrapper from \"../../data/protobufs/proto-wrapper\";\nimport EntityLayer, {Entity} from \"../../controllers/entities\";\nimport {EntityDeletePacket, EntityUpdatePacket} from \"../packets/entityPackets\";\nimport {Sprite} from \"../../util/sprite-loading\";\nimport {ProtoSprite} from \"../../data/protobufs/proto-sprite\";\nimport {ProtoEntity} from \"../../data/protobufs/proto-entity\";\n\n\nexport default class EntityUpdateHandler extends Handler {\n    readonly packets: typeof ProtoWrapper[] = [EntityUpdatePacket, EntityDeletePacket];\n    private readonly entities: EntityLayer;\n\n    constructor(entities: EntityLayer) {\n        super();\n        this.entities = entities;\n    }\n\n    async clientHandler(client: Client, packet: any): Promise<void> {\n        if (packet instanceof EntityUpdatePacket) {\n            for (const ent of packet.entities) {\n                const sprite = new Sprite(ent.sprite.id, ent.sprite.idx);\n                if (!this.entities.updateEntity(ent.id, {\n                    ...ent,\n                    sprite\n                }, false)) {\n                    console.debug('Adding new entity:', ent);\n                    this.entities.addEntity(sprite, { ...ent, sprite }, false)\n                }\n            }\n        } else if (packet instanceof EntityDeletePacket) {\n            console.debug('Deleting:', packet.entityID);\n            this.entities.remove(packet.entityID, false);\n        }\n    }\n\n    async hostHandler(client: Client, packet: any): Promise<void> {\n        if (packet instanceof EntityUpdatePacket) {\n            for (const ent of packet.entities) {\n                if (!this.entities.entityIsOwned(ent.id, client.userData.username)) {\n                    throw Error('Client attempted to edit entity the do not own!')\n                }\n                this.entities.updateEntity(ent.id, {\n                    x: ent.x,\n                    y: ent.y\n                });\n            }\n        } else {\n            throw Error(`Client sent invalid Entity packet! ${typeof packet}`)\n        }\n    }\n\n    static sendUpdate(entity: Entity) {\n        if (!entity.canMove() || !entity.visible) return;\n        const proto = new ProtoEntity().assign({\n            ...entity,\n            sprite: new ProtoSprite().assign({...entity.sprite}),\n            owners: Array.from(entity.owners)\n        });\n        const packet = new EntityUpdatePacket().assign({entities: [proto]});\n        broadcast(packet, false);\n    }\n\n    static sendDelete(entity: Entity) {\n        if (!entity.canMove()) return;\n        const packet = new EntityDeletePacket().assign({entityID: entity.id});\n        console.debug(packet);\n        broadcast(packet, true);\n    }\n}\n\n","import {Sprite} from \"../util/sprite-loading\";\nimport {imageHeightPx, imageWidthPx} from \"../consts\";\nimport {v4 as uuid} from 'uuid';\nimport EntityMiddleware from \"../middleware/entity-events\";\nimport {observable} from \"mobx\";\nimport {isHost} from \"../net/peerconnection\";\nimport EntityUpdateHandler from \"../net/handlers/entity-update-handler\";\nimport {currentUsername} from \"../db/metadata-db\";\n\n\nexport class Entity {\n    @observable sprite: Sprite;\n    @observable name: string;\n    @observable color: string = '#000000';\n    id: string;\n    x: number = 0;\n    y: number = 0;\n    @observable visible: boolean = true;\n    @observable owners: string[] = [];\n    @observable saveToCampaign: boolean = false;\n\n    constructor(sprite: Sprite, init?: Partial<Entity>) {\n        this.sprite = sprite;\n        this.id = uuid();\n        this.name = this.id;\n        if (init) {\n            Object.assign(this, init)\n        }\n    }\n\n   canMove() {\n        return isHost() || this.owners.includes(currentUsername.get());\n   }\n}\n\nexport class NamePlate {\n    static plates: NamePlate[] = [];\n    static updateTimer: any = null;\n    private readonly ele = document.createElement('div');\n    private targY: number = 0;\n    protected x: number = 0;\n    protected y: number = 0;\n    public width: number = 0;\n    public height: number = 0;\n    private parent: HTMLElement;\n    private color: string;\n\n    constructor(text: string, color: string, parent: HTMLElement) {\n        this.ele.className = 'entityNamePlate';\n        this.parent = parent;\n        this.color = color;\n        NamePlate.plates.push(this);\n        this.update(text, this.x, this.y, this.color,false);\n    }\n\n    public update(name: string, x: number, y: number, color: string, redraw: boolean = true) {\n        this.x = x;\n        this.y = y;\n        this.targY = y;\n        this.color = color;\n        this.ele.innerText = name;\n\n        if (redraw) NamePlate.plates.map(p => p.reposition()); // Update all plate positions, since one has moved.\n    }\n\n    reposition() {\n        this.y = this.targY;\n        this.width = this.ele.offsetWidth;\n        this.height = this.ele.offsetHeight;\n\n        for (let i=0; i < 10; i+=1) {\n            if (NamePlate.plates.some(o => o !== this && this.overlaps(o))) {\n                this.y -= this.height+1;\n            }\n        }\n\n        Object.assign(this.ele.style, {\n            position: 'absolute',\n            top: `${this.y}px`,\n            left: `${this.x}px`,\n            color: this.color\n        });\n    }\n\n    public overlaps(other: NamePlate) {\n        return !(this.x > other.right ||\n            this.right < other.x ||\n            this.y > other.bottom ||\n            this.bottom < other.y);\n    }\n\n    public bringToFront() {\n        this.parent.append(this.ele);\n    }\n\n    public remove() {\n        this.ele.remove();\n        NamePlate.plates = NamePlate.plates.filter(n => n !== this);\n    }\n\n    get right() {\n        return this.x + this.width;\n    }\n\n    get bottom() {\n        return this.y + this.height;\n    }\n}\n\n\nexport class EntityEle {\n    public readonly ele = document.createElement('canvas');\n    public readonly namePlate: NamePlate;\n    public readonly entity: Entity;\n    private redrawTimer: any = null;\n    private readonly ctx: CanvasRenderingContext2D;\n    private readonly parent: HTMLElement;\n    private readonly onClick: Function;\n\n    constructor(parent: HTMLElement, plateParent: HTMLElement, entity: Entity, onClick: Function) {\n        this.parent = parent;\n        this.entity = entity;\n        this.onClick = onClick;\n        // @ts-ignore\n        this.ctx = this.ele.getContext('2d');\n        this.ele.width = imageWidthPx;\n        this.ele.height = imageHeightPx;\n        this.ele.className = 'entityWrapper';\n        this.ele.addEventListener('pointerdown', () => {\n            if (this.entity.canMove()) this.onClick(this)\n        });\n\n        this.namePlate = new NamePlate(entity.name, entity.color, plateParent);\n\n        this.ele.style.opacity = this.entity.visible ? '1' : '0.5';\n        this.reposition();\n        this.bringToFront();\n        this.redraw();\n    }\n\n    internalUpdate(props: Partial<Entity>) {\n        Object.assign(this.entity, props);\n        this.ele.style.opacity = this.entity.visible ? '1' : '0.5';\n        this.reposition();\n        if (this.redrawTimer === null) this.redraw()\n    }\n\n    remove() {\n        if (this.redrawTimer !== null) {\n            clearTimeout(this.redrawTimer);\n        }\n        this.ele.remove();\n        this.namePlate.remove();\n    }\n\n    redraw() {\n        requestAnimationFrame(() => {\n            this.ctx.clearRect(0, 0, this.ele.width, this.ele.height);\n            this.entity.sprite.drawTo(this.ctx, 0, 0);\n\n            if (this.redrawTimer !== null) {\n                clearTimeout(this.redrawTimer);\n                this.redrawTimer = null;\n            }\n            if (this.entity.sprite.animated) {\n                this.redrawTimer = setTimeout(this.redraw.bind(this), 200);\n            } else {\n                this.redrawTimer = null;\n            }\n        });\n    }\n\n    private reposition() {\n        Object.assign(this.ele.style, {\n            position: 'absolute',\n            top: `${this.entity.y * imageHeightPx}px`,\n            left: `${this.entity.x * imageWidthPx}px`,\n            cursor: 'pointer'\n        });\n\n        this.namePlate.update(\n            this.entity.name,\n            this.entity.x * imageWidthPx + imageWidthPx/2,\n            this.entity.y * imageHeightPx - 14,\n            this.entity.color\n        )\n    }\n\n    bringToFront() {\n        this.parent.append(this.ele);\n        this.namePlate.bringToFront();\n    }\n\n    setInput(useInput: boolean) {\n        Object.assign(this.ele.style, {\n            'pointer-events': useInput ? 'auto' : 'none'\n        });\n    }\n}\n\nexport default class EntityLayer {\n    private readonly entityElements: Record<string, EntityEle> = {};\n    private readonly ele: HTMLElement;\n    private readonly plateEle: HTMLElement;\n    public boardWidth: number = 0;\n    public boardHeight: number = 0;\n    private enableInput: boolean = true;\n    @observable public selected: EntityEle|null = null;\n    @observable public isDirty: boolean = false;\n    private middleware: EntityMiddleware;\n\n    constructor(tileWidth: number, tileHeight: number) {\n        this.ele = document.createElement('div');\n        this.ele.className = 'entityContainer';\n        this.plateEle = document.createElement('div');\n        this.plateEle.className = 'plateContainer';\n        this.middleware = new EntityMiddleware(this.ele, this);\n        this.middleware.attach(this.ele);\n\n        this.resizeBoard(tileWidth, tileHeight);\n    }\n\n    private resizeBoard(width: number, height: number) {\n        this.boardWidth = width;\n        this.boardHeight = height;\n        for (const {entity} of Object.values(this.entityElements)) {\n            const x = entity.x;\n            const y = entity.y;\n            if (x > this.boardWidth || y > this.boardHeight) {\n                this.remove(entity.id);\n            }\n        }\n    }\n\n    /**  Derive new tile widthxheight whenever this canvas is resized. */\n    public setSize(width: number, height: number) {\n        Object.assign(this.ele.style, { width: `${width}px`, height: `${height}px`});\n        Object.assign(this.plateEle.style, { width: `${width}px`, height: `${height}px`});\n        this.resizeBoard(Math.floor(width/imageWidthPx), Math.floor(height/imageHeightPx));\n    }\n\n    public remove(id: string, sendUpdate: boolean = true): boolean {\n        const existing = this.entityElements[id];\n        if (existing) {\n            this.entityElements[id].remove();\n            delete this.entityElements[id];\n            if (sendUpdate) EntityUpdateHandler.sendDelete(existing.entity);\n        }\n        if (existing === this.selected) this.selected = null;\n        return !!existing;\n    }\n\n    public addEntity(sprite: Sprite, opts?: Partial<Entity>, sendUpdate: boolean = true) {\n        const ent = new Entity(sprite, opts);\n        const entEle = new EntityEle(this.ele, this.plateEle, ent, this.select.bind(this));\n\n        entEle.setInput(this.enableInput);\n        this.entityElements[ent.id] = entEle;\n\n        if (sendUpdate) {\n            EntityUpdateHandler.sendUpdate(ent);\n            this.isDirty = true;\n        }\n\n        // Upon creation, we need a frame for the bounding box to update with the new name:\n        if (NamePlate.updateTimer !== null) clearTimeout(NamePlate.updateTimer);\n        NamePlate.updateTimer = setTimeout(() => NamePlate.plates.map(p => p.reposition()), 1);\n\n        return ent;\n    }\n\n    public select(entEle: EntityEle|null) {\n        this.selected = entEle;\n        console.debug('Selected entity:', this.selected);\n        this.middleware.setTarget(entEle);\n        if (this.selected) {\n            Object.values(this.entityElements).forEach(e => {\n                if (e !== this.selected) e.setInput(false)\n            });\n        }\n    }\n\n    public entityIsOwned(id: string, checkOwner: string) {\n        const existing = this.entityElements[id];\n        if (existing) {\n            return existing.entity.owners.includes(checkOwner);\n        }\n        return false;\n    }\n\n    public updateEntity(id: string, props: Partial<Entity>, sendUpdate: boolean=true) {\n        const existing = this.entityElements[id];\n        if (existing) {\n            existing.internalUpdate(props);\n            if (sendUpdate) {\n                EntityUpdateHandler.sendUpdate(existing.entity);\n                this.isDirty = true;\n            }\n        }\n        return !!existing;\n    }\n\n    public toggleInput(enabled: boolean, acceptHover: boolean = true) {\n        if (enabled !== this.enableInput) {\n            this.enableInput = enabled;\n            Object.values(this.entityElements).forEach(ent => {\n                ent.setInput(enabled);\n            });\n            Object.assign(this.ele.style, {\n                'pointer-events': (!acceptHover || this.enableInput) ? 'none' : 'auto'\n            });\n        }\n    }\n\n    /**\n     * Directly export the underlying terrain map, for serialization.\n     */\n    getEntityList() {\n        return Object.values(this.entityElements).map(e => e.entity);\n    }\n\n    public appendTo(ele: HTMLDivElement) {\n        ele.append(this.ele);\n        ele.append(this.plateEle)\n    }\n}\n","import {Client} from \"../peerconnection\";\nimport GameController from \"../../controllers/game\";\n\n\nexport abstract class PreCheck {\n    protected readonly controller: GameController;\n    run: OmitThisParameter<(isHost: boolean, client: Client) => Promise<void>>;\n\n    public constructor(controller: GameController) {\n        this.controller = controller;\n        this.run = this.runHandler.bind(this);\n    }\n\n    private async runHandler(isHost: boolean, client: Client){\n        return isHost ? this.host(client) : this.client(client);\n    }\n\n    abstract async client(client: Client): Promise<void>;\n    abstract async host(client: Client): Promise<void>;\n}\n","import Dexie from \"dexie\";\n\nexport interface UserData {\n    id: number;\n    username: string;\n    keyCodes: string[];\n    lastSeen: number;\n}\n\nclass UserDB extends Dexie {\n    users: Dexie.Table<any, UserData>;\n\n    constructor() {\n        super('user-db');\n\n        // Define tables and indexes\n        this.version(1).stores({\n            users: '++id, &username, *keyCodes, lastSeen'\n        });\n        this.users = this.table(\"users\");\n    }\n}\n\n\nconst db = new UserDB();\n\nexport async function addNewUser(user: Partial<UserData>): Promise<UserData> {\n    const data = {\n        id: 0,\n        username: '',\n        keyCodes: [],\n        ...user,\n        lastSeen: new Date().getTime()\n    };\n    await db.users.put(data);\n    return data;\n}\n\nexport async function updateUser(user: UserData): Promise<number> {\n    return db.users.update(user.id, user);\n}\n\nexport async function getUser(username: string): Promise<UserData|null> {\n    return db.users.where({username}).first();\n}\n\n/**\n * Checks if the given User code matches an existing username.\n * If so, also updates the lastSeen time of the user.\n * @param userName\n * @param keyCode\n */\nexport async function checkUserCredentials(userName: string, keyCode: string): Promise<UserData> {\n    const match = await db.users.where({username: userName, keyCodes: keyCode}).first();\n\n    if (match) {\n        match.lastSeen = new Date().getTime();\n        await updateUser(match);\n    }\n\n    return match;\n}\n","import {Client} from \"../peerconnection\";\nimport {exportKeys, pack, unpack} from \"../crypter\";\nimport {PreCheck} from \"./precheck\";\nimport {addNewUser, checkUserCredentials, getUser, updateUser} from \"../../db/user-db\";\nimport * as metadata from '../../db/metadata-db';\nimport {ReadyPacket, SignaturePacket} from \"../packets/util-packets\";\n\n\nexport default class HandShakeCheck extends PreCheck {\n    /**\n     * Accepts a signed JSON packet, and validates the signature.\n     * The validation is an async race condition, so responds with an OK packet once finished.\n     * @param client\n     */\n    async client(client: Client): Promise<void> {\n        const data: SignaturePacket = await client.getNextPacket(SignaturePacket);\n        const pk = JSON.parse(data.signedJSON)?.pubKey;\n        const ob = await unpack(client.roomID, pk, data.signedJSON);\n\n        if (ob.pubKey && ob.pubKey === pk) {\n            console.debug('Validated host ID.');\n\n            // Respond with client's own signed auth packet.\n            const { pubKey, roomID } = await exportKeys();\n            const username = await metadata.getUsername();\n            const packet = new SignaturePacket().assign({\n                signedJSON: await pack({\n                    pubKey,\n                    username,\n                    roomID\n                })\n            });\n            await client.send(packet);\n\n            await client.getNextPacket(ReadyPacket); // Wait for host to allow out login.\n        }\n    }\n\n    /**\n     * Sends a signed JSON packet, to validate this host ID.\n     * Awaits an OK Packet from the client, once validation is complete.\n     * @param client\n     */\n    async host(client: Client): Promise<void> {\n        // Send a signed message to verify we're the real host:\n        const packet = new SignaturePacket().assign({\n            signedJSON: await pack({\n                pubKey: (await exportKeys()).pubKey\n            })\n        });\n        await client.send(packet);\n\n        // Wait for client to respond with signed message containing username:\n        const data: SignaturePacket = await client.getNextPacket(SignaturePacket);\n        const raw = JSON.parse(data.signedJSON);\n        const ob = await unpack(raw.roomID, raw.pubKey, data.signedJSON);\n        const {username, roomID} = ob;\n\n        let user = await checkUserCredentials(username, roomID);\n        if (!user) {\n            let existing = await getUser(username);\n\n            await this.controller.lobby.addPendingLogin(username, roomID);  // Will be approved via UI, by the Host.\n\n            if (!existing) {\n                console.log(`Added new user: ${username}, ${roomID}`);\n                existing = await addNewUser({username, keyCodes: [roomID]});\n            } else {\n                console.log(`Updated existing user: ${username}, ${roomID}`);\n                existing.keyCodes.push(roomID);\n                await updateUser(existing);\n            }\n            user = existing;\n        }\n\n        client.userData = user;\n        await client.send(new ReadyPacket())\n    }\n}\n\n","import {Client} from \"../peerconnection\";\nimport {PreCheck} from \"./precheck\";\n\n\nexport default class BoardSync extends PreCheck {\n    /**\n     * Waits for a ProtoBoard, which is then used to seed the initial board status.\n     * @param client\n     */\n    async client(client: Client) {}\n\n    /**\n     * Issues a ProtoBoard, containing the initial board status, to the client.\n     * @param client\n     */\n    async host(client: Client) {\n        await client.send(await this.controller.buildProtoBoard(false));\n    }\n}\n","import {observable} from \"mobx\";\nimport notifications from \"../../ui-components/notifications\";\n\n\nexport interface PendingUser {\n    username: string;\n    keyCode: string;\n    approve: Function;\n    reject: Function;\n}\n\nexport default class Lobby {\n    @observable public readonly pendingLogins: PendingUser[] = [];\n    @observable public myName: string = '';\n    private readonly blacklist: Set<String> = new Set();\n\n    private notify(title: string, body: string, iconURL: string='') {\n        Notification.requestPermission().then(function(result) {\n            if (result === 'granted') {\n                new Notification(title, {\n                    body,\n                    icon: iconURL // TODO: Path to alert icon image.\n                });\n            }\n        });\n    }\n\n    /**\n     * Adds the given login attempt to the pending list,\n     * and returns a Promise that will either resolve or reject eventually at the Hosts' discretion.\n     * @param username\n     * @param keyCode\n     */\n    public async addPendingLogin(username: string, keyCode: string) {\n        return new Promise((approve, reject) => {\n            const existing = Array.from(this.pendingLogins).find(pe => pe.keyCode === keyCode);\n            const pending = { username, keyCode, approve, reject };\n\n            if (existing) {\n                this.removePending(existing);\n            }\n            this.pendingLogins.push(pending);\n\n            if (!this.blacklist.has(keyCode)) {\n                notifications.warning(`Unknown device (${keyCode}) wants to join as \"${username}\".`, {});\n                this.notify('New Unknown User', `Unknown device (${keyCode}) wants to join as \"${username}\".`);\n            }\n        });\n    }\n\n    public approveUser(user: PendingUser) {\n        user.approve(true);\n        notifications.success(`Approved user \"${user.username}\".`)\n        this.removePending(user);\n    }\n\n    public rejectUser(user: PendingUser) {\n        user.reject(false);\n        notifications.error(`Rejected device (${user.keyCode}).`)\n        this.removePending(user);\n        this.blacklist.add(user.keyCode);\n    }\n\n    private removePending(user: PendingUser) {\n        const idx = this.pendingLogins.findIndex(u => u.keyCode === user.keyCode);\n        if (idx >= 0) {\n            this.pendingLogins.splice(idx, 1);\n        }\n    }\n}\n","import Handler from \"./handler\";\nimport ProtoWrapper from \"../../data/protobufs/proto-wrapper\";\nimport {PingPacket} from \"../packets/util-packets\";\nimport {Client} from \"../peerconnection\";\n\n\nexport default class PingHandler extends Handler {\n    readonly packets: typeof ProtoWrapper[] = [PingPacket];\n\n    async clientHandler(client: Client, packet: ProtoWrapper): Promise<void> {\n        PingHandler.handlePing(client);\n    }\n\n    async hostHandler(client: Client, packet: ProtoWrapper): Promise<void> {\n        PingHandler.handlePing(client);\n    }\n\n    private static handlePing(client: Client) {\n        client.lastPing = Date.now();\n    }\n}\n","import Dexie from \"dexie\";\nimport {ProtoBoard} from \"../data/protobufs/proto-tiles\";\nimport * as encoder  from '../net/messageEncoder'\nimport notifications from \"../../ui-components/notifications\";\n\nexport interface BoardWrapper {\n    name: string;\n    campaignID: number;\n    data: Uint8Array;\n}\n\n\nclass BoardDB extends Dexie {\n    boards: Dexie.Table<any, BoardWrapper>;\n\n    constructor() {\n        super('board-db');\n\n        // Define tables and indexes\n        this.version(1).stores({\n            boards: '&[campaignID+name]'\n        });\n        this.boards = this.table(\"boards\");\n    }\n}\n\nconst db = new BoardDB();\n\nexport async function save(campaignID: number, name: string, board: ProtoBoard) {\n    return db.boards.put({\n        name,\n        campaignID,\n        data: await encoder.encode(board)\n    }).catch(err => {\n        notifications.error('Error saving board!');\n        console.error(err);\n    })\n}\n\nexport async function load(campaignID: number, name: string): Promise<null|ProtoBoard> {\n    const res: BoardWrapper|null = await db.boards.where({campaignID, name}).first().catch(err => {\n        notifications.error('Error loading board!');\n        console.error(err);\n    })\n\n    if (res) {\n        return encoder.decode(res.data);\n    } else {\n        return null;\n    }\n}\n\nexport async function getAvailable(campaignID: number): Promise<string[]> {\n    try {\n        return (await db.boards.where('[campaignID+name]').between([campaignID, Dexie.minKey], [campaignID, Dexie.maxKey]).toArray()).map(b=>b.name);\n    } catch(err) {\n        notifications.error('Error fetching available boards!');\n        console.error(err);\n        return [];\n    }\n}\n\n\nexport async function deleteBoard(campaignID: number, name: string) {\n    return db.boards.where({campaignID, name}).delete();\n}\n","import {observable} from \"mobx\";\nimport {Entity} from \"./entities\";\n\nexport default class Campaign {\n    public readonly name: string;\n    @observable public boards: string[] = [];\n    @observable public loadedBoard: string|null = null;\n    @observable public readonly characters: Entity[] = [];\n    public readonly id: number = -1;\n    public readonly timeCreated = Date.now();\n\n    constructor(name: string) {\n        this.name = name;\n    }\n}\n","/**\n * Strip out any proxied observables, and convert them to standard values.\n * @param obj\n */\nexport default function stripProxy(obj: any): any {\n    const ret = {};\n    for (const e of Object.entries(obj)) {\n        let v = e[1];\n\n        if (v instanceof Array) {\n            v = Array.from(v);\n        }\n        // @ts-ignore\n        ret[e[0]] = v;\n    }\n    return ret;\n}\n","import Dexie from \"dexie\";\nimport Campaign from \"../controllers/campaign\";\nimport stripProxy from \"../util/deproxy\";\n\nclass CampaignDB extends Dexie {\n    campaigns: Dexie.Table<any, Campaign>;\n\n    constructor() {\n        super('campaign-db');\n\n        // Define tables and indexes\n        this.version(1).stores({\n            campaigns: '++id, name'\n        });\n        this.campaigns = this.table(\"campaigns\");\n    }\n}\n\n\nconst db = new CampaignDB();\ndb.campaigns.mapToClass(Campaign);\n\nexport async function saveCampaign(camp: Campaign) {\n    console.info('Saved campaign:', camp);\n    return db.campaigns.update(camp.id, stripProxy(camp));\n}\n\nexport async function createCampaign(name: string): Promise<any> {\n    const obj = {...new Campaign(name), id: null};\n    delete obj.id;\n\n    const res = await db.campaigns.put(stripProxy(obj));\n    console.info('Saved new campaign:', res);\n    return db.campaigns.get({id: res});\n}\n\nexport async function getAllCampaigns(): Promise<Campaign[]> {\n    return db.campaigns.toArray()\n}\n\nexport async function getCampaign(id: number): Promise<Campaign|null> {\n    return db.campaigns.where({id}).first()\n}\n","import {getAllCampaigns, getCampaign, saveCampaign, createCampaign} from \"../db/campaign-db\";\nimport * as boardDB from '../db/board-db';\nimport Campaign from \"../controllers/campaign\";\n\n\nexport default class CampaignLoader {\n    /**\n     * Get an array of all saved Campaign objects.\n     */\n    public static async getAvailable(): Promise<Campaign[]> {\n        return getAllCampaigns()\n    }\n\n    /**\n     * Load a Campaign object from the db, using its unique ID.\n     * @param id\n     */\n    public static async loadCampaign(id: number): Promise<Campaign|null> {\n        const campaign = await getCampaign(id);\n\n        if (campaign) campaign.boards = await boardDB.getAvailable(id);\n\n        if (campaign && campaign.loadedBoard && !campaign.boards.includes(campaign.loadedBoard)) {\n            campaign.loadedBoard = null;\n        }\n\n        return campaign;\n    }\n\n    /**\n     * Save an existing Campaign object back to the database.\n     * @param camp\n     */\n    public static async saveCampaign(camp: Campaign): Promise<number> {\n        return saveCampaign({\n            ...camp,\n            boards: Array.from(camp.boards)\n        }).catch(err => {\n            console.error(err)\n            return -1;\n        });\n    }\n\n    /**\n     * Create a new Campaign object, pre-saved in the database.\n     * @param name\n     */\n    public static async createCampaign(name: string): Promise<Campaign> {\n        return createCampaign(name);\n    }\n}\n\n","import Handler from \"./handler\";\nimport ProtoWrapper from \"../../data/protobufs/proto-wrapper\";\nimport {ProtoBoard} from \"../../data/protobufs/proto-tiles\";\nimport {Client} from \"../peerconnection\";\nimport GameController from \"../../controllers/game\";\n\n\nexport default class BoardReloadHandler extends Handler {\n    readonly packets: typeof ProtoWrapper[] = [ProtoBoard];\n    private readonly controller: any;\n\n    constructor(controller: GameController) {\n        super();\n        this.controller = controller;\n    }\n\n    async clientHandler(client: Client, packet: ProtoBoard): Promise<void> {\n        return this.controller.loadFromProtoBoard(packet);\n    }\n\n    async hostHandler(client: Client, packet: ProtoWrapper): Promise<void> {\n        throw Error('Client tried to send Board Update!')\n    }\n}\n","import {CanvasContainer} from \"./canvas\";\nimport {Sprite, waitForSpriteLoad} from \"../util/sprite-loading\";\nimport Terrain from \"./terrain\";\nimport {boardTileHeight, boardTileWidth, imageHeightPx, imageWidthPx} from \"../consts\";\nimport {observable} from \"mobx\";\nimport {getMyRoomID, initKeys} from \"../net/crypter\";\nimport * as connection from '../net/peerconnection'\nimport {broadcast, NetworkStatus} from \"../net/peerconnection\";\nimport EntityLayer from \"./entities\";\nimport HandShakeCheck from \"../net/prechecks/signature-check\";\nimport BoardSync from \"../net/prechecks/board-sync-check\";\nimport {PreCheck} from \"../net/prechecks/precheck\";\nimport Handler from \"../net/handlers/handler\";\nimport TerrainAddHandler from \"../net/handlers/terrain-add-handler\";\nimport TerrainEraseHandler from \"../net/handlers/terrain-erase-handler\";\nimport EntityUpdateHandler from \"../net/handlers/entity-update-handler\";\nimport Lobby from \"./lobby\";\nimport PingHandler from \"../net/handlers/ping-handler\";\nimport Campaign from \"./campaign\";\nimport * as boardDB from \"../db/board-db\";\nimport {ProtoBoard} from \"../data/protobufs/proto-tiles\";\nimport * as packer from \"../data/board-packer.worker\";\nimport {ProtoEntity} from \"../data/protobufs/proto-entity\";\nimport CampaignLoader from \"../data/campaign-loader\";\nimport BoardReloadHandler from \"../net/handlers/board-reload-handler\";\n\n\nexport default class GameController {\n    public canvasContainer: CanvasContainer;\n    public terrain: Terrain;\n    public entities: EntityLayer;\n    @observable public ready: boolean = false;\n    private readonly preChecks: PreCheck[];\n    private readonly handlers: Handler[];\n    public readonly lobby: Lobby;\n    @observable public campaign: Campaign|null = null;\n\n    constructor() {\n        this.canvasContainer = new CanvasContainer(1, 1);\n        this.terrain = new Terrain(boardTileWidth, boardTileHeight);\n        this.entities = new EntityLayer(boardTileWidth, boardTileHeight);\n        this.lobby = new Lobby();\n\n        // Initialize networking stuff:\n        this.preChecks = [\n            new HandShakeCheck(this),\n            new BoardSync(this)\n        ];\n        this.handlers = [\n            new TerrainAddHandler(this.terrain),\n            new TerrainEraseHandler(this.terrain),\n            new EntityUpdateHandler(this.entities),\n            new PingHandler(),\n            new BoardReloadHandler(this)\n        ];\n    }\n\n    /**\n     * Starts the main game client, waiting for the Sprite Loader to become ready.\n     * Also initializes any required keys or other async setup.\n     * Automatically starts the Client/Host connection if a URL Hash has been set already.\n     */\n    public async start() {\n        this.canvasContainer.addLayer(this.terrain);\n        this.canvasContainer.addLayer(this.entities);\n\n        await waitForSpriteLoad;\n        console.debug('Sprite loader ready!');\n\n        this.canvasContainer.setCanvasSize(boardTileWidth * imageWidthPx, boardTileHeight * imageHeightPx);\n\n        await initKeys();\n        console.log('Local Room ID Key:', await getMyRoomID());\n\n        const hash = window.location.hash.replace('#', '');\n        if (hash) {\n            if ((await getMyRoomID()) === hash) {\n                // This is our URL - hosting.\n                await this.startHost();\n            } else {\n                // At someone else's URL - join them.\n                await this.startClient(hash);\n            }\n        }\n        this.ready = true;\n\n        // Treadmill to block back button:\n        window.history.pushState(null, document.title, window.location.href);\n        window.addEventListener('popstate', () => {\n            window.history.pushState(null, document.title, window.location.href);\n        });\n    }\n\n    public async startHost(): Promise<void> {\n        await connection.kill();\n        this.lobby.pendingLogins.forEach(pu => this.lobby.rejectUser(pu));\n\n        console.log('Hosting lobby at:', await getMyRoomID());\n        window.location.hash = await getMyRoomID();\n\n        this.handlers.forEach(h => h.setHost(true));\n        connection.setHandlers(this.handlers, this.preChecks);\n\n        await connection.openHost();\n    }\n\n    public async startClient(connectID: string) {\n        await connection.kill();\n        this.lobby.pendingLogins.forEach(pu => this.lobby.rejectUser(pu));\n\n        console.log('Connecting to host:', connectID);\n        window.location.hash = connectID;\n\n        this.handlers.forEach(h => h.setHost(false));\n        connection.setHandlers(this.handlers, this.preChecks)\n\n        await connection.connectTo(connectID);\n    }\n\n    get isNetworkReady() {\n        return connection.netStatus.get() === NetworkStatus.CONNECTED;\n    }\n\n    /**\n     * Loads the given board, and broadcasts the new board state to all clients.\n     * @param name\n     */\n    public async loadBoard(name: string): Promise<boolean> {\n        if (!this.campaign) return false;\n\n        this.campaign.loadedBoard = name;\n        this.terrain.isBoardDirty = false;\n        this.entities.isDirty = false;\n\n        const board: ProtoBoard|null = await boardDB.load(this.campaign.id, name);\n\n        if (!board) return false;  // Erase existing only if the loaded board actually exists.\n\n        await this.loadFromProtoBoard(board);\n\n        broadcast(await this.buildProtoBoard(false), true).catch(console.error);\n\n        this.terrain.isBoardDirty = false;  // May have triggered a \"redraw\", so reset these flags here.\n        this.entities.isDirty = false;\n\n        return true;\n    }\n\n    public async loadFromProtoBoard(pb: ProtoBoard) {\n        this.terrain.setDirectMap(pb);\n\n        this.entities.getEntityList().forEach(e => this.entities.remove(e.id, false));\n        pb.entities.forEach(ent => {\n            const sprite = new Sprite(ent.sprite.id, ent.sprite.idx);\n            this.entities.addEntity(sprite, {\n                ...ent,\n                sprite\n            }, false)\n        });\n    }\n\n    public async buildProtoBoard(includeHidden: boolean = true) {\n        const tiles = Object.values(this.terrain.getDirectMap()).flat();\n        const pb = new ProtoBoard().assign(await packer.packBoard(tiles));\n\n        pb.entities = this.entities.getEntityList().filter(e=>includeHidden||e.visible).map(e => ProtoEntity.fromEntity(e));\n\n        return pb;\n    }\n\n    public async saveBoard(): Promise<boolean> {\n        if (!this.campaign || !this.campaign.loadedBoard) return false;\n\n        const pb = await this.buildProtoBoard(true);\n        await boardDB.save(this.campaign.id, this.campaign.loadedBoard, pb);\n\n        this.terrain.isBoardDirty = false;\n        this.entities.isDirty = false;\n\n        await CampaignLoader.saveCampaign(this.campaign);\n\n        return true;\n    }\n\n    public async deleteBoard(campaign: Campaign, name: string): Promise<boolean> {\n        const idx = campaign.boards.indexOf(name);\n\n        if (idx < 0) {\n            return false;\n        }\n\n        campaign.boards.splice(idx, 1);\n\n        if (campaign.loadedBoard === name) {\n            campaign.loadedBoard = null;\n        }\n\n        await boardDB.deleteBoard(campaign.id, name);\n        await CampaignLoader.saveCampaign(campaign);\n\n        return true;\n    }\n}\n","import GameController from \"../game/controllers/game\";\n\n/**\n * A wrapper to connect the UI controls to the actual game, typically through middleware.\n * The interfaces generated should be agnostic of the platform, for maximum compatibility.\n */\nexport default abstract class UITool {\n    public readonly abstract name: string;\n    public readonly abstract icon: JSX.Element;\n    protected readonly controller: GameController;\n\n    public constructor(controller: GameController) {\n        this.controller = controller;\n    }\n\n    abstract getControlUI(forMobile: boolean): JSX.Element|null;\n    abstract register(): any;\n    abstract unregister(): any;\n    abstract isOption(forMobile: boolean, isHost: boolean): boolean;\n}\n","import Middleware from \"./middleware\";\nimport Terrain from \"../controllers/terrain\";\nimport {imageHeightPx, imageWidthPx} from \"../consts\";\nimport {observable} from \"mobx\";\nimport {CanvasContainer} from \"../controllers/canvas\";\nimport EntityLayer from \"../controllers/entities\";\n\nexport default class PenMiddleware extends Middleware {\n    private readonly terrain: Terrain;\n    private state: number = -1;\n    private readonly canUsePen: boolean;\n    @observable public penSize: number = 1;\n    private container: CanvasContainer;\n    private readonly hoverBox: HTMLElement;\n    private readonly entities: EntityLayer;\n    private toggle: boolean = false;\n\n    constructor(terrain: Terrain, entities: EntityLayer, container: CanvasContainer, canUsePen: boolean=true) {\n        super();\n        this.terrain = terrain;\n        this.entities = entities;\n        this.container = container;\n        this.canUsePen = canUsePen;\n        this.hoverBox = document.createElement('div');\n    }\n\n    register(): void {\n        this.container.addElement(this.hoverBox);\n        this.entities.toggleInput(false, false);\n\n        this.listen('keydown', (ke: KeyboardEvent) => {\n            if (ke.code.startsWith('Shift') && !this.toggle) {\n                this.toggle = true;\n                this.entities.toggleInput(true);\n                this.hoverBox.remove();\n            }\n        }, document.body);\n\n        this.listen('keyup', (ke: KeyboardEvent) => {\n            if (ke.code.startsWith('Shift')) {\n                this.toggle = false;\n                this.entities.toggleInput(false, false);\n                this.container.addElement(this.hoverBox);\n            }\n        }, window);\n\n        this.listen('mousemove', (ev: MouseEvent) => {\n            this.updateHighlight(ev);\n        });\n\n        this.listen('pointerdown', (ev: PointerEvent) => {\n            if (ev.shiftKey) {\n                return;\n            }\n            if (ev.button === 1) {\n                // Middle mouse \"dropper\":\n                const [xx, yy] = PenMiddleware.toGrid(ev);\n                const sp = this.terrain.getAt(xx, yy);\n                if (sp.length) {\n                    this.terrain.selectedSprite = sp[sp.length-1].sprite;\n                    return true;\n                }\n            }\n            this.state = ev.button;\n            return this.draw(ev);\n        });\n\n        this.listen('pointerup', (ev: PointerEvent) => {\n            if (this.state >= 0) {\n                ev.preventDefault();\n                ev.stopPropagation();\n                this.state = -1;\n            }\n        }, window);\n\n        this.listen('pointermove', (ev: PointerEvent) => {\n            return this.draw(ev);\n        });\n\n        this.listen('wheel', (ev: WheelEvent) => {\n            if (!ev.shiftKey) {\n                const out = Math.sign(ev.deltaY) * -1;\n                this.penSize = Math.max(1, Math.min(8, this.penSize += out));\n                this.updateHighlight(ev);\n                return true;\n            }\n        });\n    }\n\n    draw(ev: PointerEvent): boolean {\n        if (this.state >= 0) {\n            const [xx, yy] = PenMiddleware.toGrid(ev);\n            this.updateHighlight(ev);\n\n            switch (this.state) {\n                case 2:\n                    this.box(xx, yy, this.terrain.eraseAt.bind(this.terrain));\n                    break;\n                case 0:\n                    if (this.canUsePen) this.box(xx, yy, this.terrain.drawAt.bind(this.terrain));\n                    else if (!this.canUsePen) this.box(xx, yy, this.terrain.eraseAt.bind(this.terrain));\n            }\n            return true;\n        }\n        return false;\n    }\n\n    updateHighlight(ev: Event) {\n        const [x, y] = PenMiddleware.toGrid(ev);\n        Object.assign(this.hoverBox.style,{\n            border: '3px solid orangered',\n            left: `${x*imageWidthPx - (this.penSize-1) * imageWidthPx}px`,\n            top: `${y*imageHeightPx - (this.penSize-1) * imageHeightPx}px`,\n            width: `${(this.penSize*2-1) * imageWidthPx - 3}px`,\n            height: `${(this.penSize*2-1) * imageHeightPx - 3}px`,\n            position: 'absolute',\n            'pointer-events': 'none',\n            'z-index': 1\n        });\n    }\n\n    private static toGrid(ev: any) {\n        const x = Math.floor(ev.offsetX/imageWidthPx);\n        const y = Math.floor(ev.offsetY/imageHeightPx);\n        return [x, y]\n    }\n\n    private box(x: number, y: number, op: Function) {\n        for (let xx = x - (this.penSize-1); xx < x + this.penSize; xx++) {\n            for (let yy = y - (this.penSize-1); yy < y + this.penSize; yy++) {\n                op(xx, yy);\n            }\n        }\n    }\n\n    protected onCleanup(): void {\n        this.container.removeElement(this.hoverBox);\n        this.entities.toggleInput(true);\n    }\n}\n","import React from 'react';\nimport {FormControlLabel, Modal, Switch, TextField} from \"@material-ui/core\";\nimport FormGroup from '@material-ui/core/FormGroup';\nimport {searchImages, Sprite} from \"../game/util/sprite-loading\";\nimport {imageHeightPx, imageWidthPx} from '../game/consts';\nimport '../styles/sprite-picker.scss'\nimport AutoSizer from 'react-virtualized-auto-sizer';\nimport {FixedSizeGrid} from \"react-window\";\nimport {createStyles, makeStyles, Theme} from \"@material-ui/core/styles\";\nimport {Autocomplete} from \"@material-ui/lab\";\n\n\nexport default function SpritePicker (\n    props: {\n        onSelect: Function,\n        onSearch?: Function,\n        defaultTerm?: string,\n        selected?: Sprite|null,\n        animated?: boolean\n        canAnimate?: boolean\n    }) {\n    const [searchTerm, setSearch] = React.useState(props.defaultTerm || '');\n    const [animated, setAnimated] = React.useState(!!props.animated);\n    const [sprites, setSprites] = React.useState<Sprite[]>([]);\n\n    const handleChange = (value: string) => {\n        setSearch(value);\n        if (props.onSearch) {\n            props.onSearch(value);\n        }\n    };\n    const animChange = (event: React.ChangeEvent<HTMLInputElement>) => {\n        setAnimated(event.target.checked);\n    };\n\n    React.useEffect(() => {\n        const timeout = setTimeout(() => {\n            const results = searchImages(searchTerm, animated, false);\n            setSprites(results);\n        }, 200)\n        return () => {\n            clearTimeout(timeout);\n        }\n    }, [searchTerm, animated]);\n\n\n    return <div style={{\n        maxWidth: '600px'\n    }}>\n        <form noValidate autoComplete=\"off\" onSubmit={e => e.preventDefault()}>\n            <FormGroup row>\n                <Autocomplete\n                    selectOnFocus={true}\n                    options={[]}\n                    style={{ width: 300 }}\n                    freeSolo={true}\n                    value={searchTerm}\n                    inputValue={searchTerm}\n                    onInputChange={(event, newInputValue) => {\n                        handleChange(newInputValue);\n                    }}\n                    renderInput={(params) => <TextField {...params} label=\"Search Sprites!\" variant=\"outlined\" />}\n                />\n                <FormControlLabel\n                    control={\n                        <Switch\n                            checked={animated}\n                            onChange={animChange}\n                            disabled={!props.canAnimate}\n                            name=\"checkedA\"\n                            inputProps={{ 'aria-label': 'secondary checkbox' }}\n                        />\n                    }\n                    label=\"Animated\"\n                    labelPlacement=\"top\"\n                />\n            </FormGroup>\n        </form>\n        <div style={{height: '280px'}}>\n            <SpriteGrid sprites={sprites} onSelect={props.onSelect} selected={props.selected} />\n        </div>\n    </div>;\n}\n\n\nexport function SpriteGrid(props: {sprites: Sprite[], onSelect: Function, selected?: Sprite|null}) {\n    return <AutoSizer className={'autosizer'}>\n        {function size(size: { height: number, width: number }){\n            const wrapperSize = 52;\n            const perRow = Math.floor(size.width/wrapperSize);\n            const rowCount = Math.ceil(props.sprites.length/ perRow);\n\n            return <FixedSizeGrid\n                columnCount={perRow}\n                columnWidth={wrapperSize}\n                height={size.height}\n                width={size.width}\n                rowCount={rowCount}\n                rowHeight={wrapperSize}\n                className={'spriteGrid'}\n                style={{maxHeight: `${size.height}px`}}\n            >\n                {(data: { columnIndex: number, rowIndex: number, style: any }) => {\n                    const spr = props.sprites[data.columnIndex + data.rowIndex * perRow];\n                    if (spr) {\n                        return <div style={data.style}>\n                            <SpriteImage sprite={spr} onSelect={props.onSelect} selected={props.selected?.composite === spr.composite}/>\n                        </div>\n                    } else {\n                        return <div/>\n                    }\n                }}\n            </FixedSizeGrid>\n        }}\n    </AutoSizer>\n}\n\n\nexport function SpriteImage(props: {sprite: Sprite|null, onSelect?: Function, selected?: boolean}) {\n    const canv: any = React.useRef(null);\n    // @ts-ignore\n    const sel = props.onSelect ? () => props.onSelect(props.sprite) : ()=>{};\n\n    React.useEffect(() => {\n        const redraw = () => {\n            if (canv.current){\n                // @ts-ignore\n                const ctx: CanvasRenderingContext2D = canv.current.getContext('2d');\n                ctx.clearRect(0,0,canv.current.width, canv.current.height);\n                props.sprite?.drawTo(ctx, 0, 0);\n            }\n        };\n        const cancel: any = props.sprite?.animated ? setInterval(redraw, 200) : null;\n        redraw();\n\n        return () => {\n            if (cancel !== null) {\n                clearInterval(cancel);\n            }\n        }\n    }, [props.sprite])\n\n    return <canvas\n        ref={canv}\n        width={imageWidthPx}\n        height={imageHeightPx}\n        style={{width: '48px', height: '48px', background: 'gray'}}\n        className={`spriteImage ${props.selected ? 'selected': ''}`}\n        title={props.sprite?.name || 'No Sprite'}\n        onClick={sel}\n    />\n}\n\nconst useStyles = makeStyles((theme: Theme) =>\n    createStyles({\n        paper: {\n            backgroundColor: theme.palette.background.paper,\n            border: '2px solid #000',\n            boxShadow: theme.shadows[5],\n            padding: theme.spacing(2, 4, 3),\n            pointerEvents: 'auto',\n            maxWidth: '600px',\n            minWidth: '400px',\n            position: 'fixed',\n            left: '50%',\n            top: '50%',\n            transform: `translate(-50%, -50%)`,\n        }\n    }),\n);\n\nexport function SpritePickerModal(props: {open: boolean, onClose: Function, onSelect: Function, currentSprite: Sprite|null}) {\n    const classes = useStyles();\n    return <Modal\n        open={props.open}\n        aria-labelledby=\"simple-modal-title\"\n        aria-describedby=\"simple-modal-description\"\n        onClose={()=>props.onClose()}\n    >\n        <div className={classes.paper}>\n            <SpritePicker\n                defaultTerm={props.currentSprite?.name || ''}\n                selected={props?.currentSprite || null}\n                animated={props?.currentSprite?.animated || true}\n                onSelect={(sp: Sprite) => {\n                    props.onClose();\n                    props.onSelect(sp);\n                }}\n                canAnimate={true}\n            />\n        </div>\n    </Modal>\n}\n","import React from \"react\";\nimport UITool from \"./ui-tool\";\nimport PenMiddleware from \"../game/middleware/pen-events\";\nimport GameController from \"../game/controllers/game\";\nimport SpritePicker from \"../ui-components/spritepicker\";\nimport { Sprite } from \"../game/util/sprite-loading\";\nimport TerrainIcon from '@material-ui/icons/Terrain';\nimport {observer} from \"mobx-react-lite\";\nimport Terrain from \"../game/controllers/terrain\";\nimport {Slider, Typography} from \"@material-ui/core\";\n\nexport default class UIPenTool extends UITool {\n    readonly icon: JSX.Element = <TerrainIcon />;\n    readonly name: string = 'Terrain';\n    readonly middleware: PenMiddleware;\n    private searchTerm: string = 'ground';\n\n    constructor(controller: GameController) {\n        super(controller);\n        this.middleware = new PenMiddleware(controller.terrain, controller.entities, controller.canvasContainer);\n    }\n\n    getControlUI(forMobile: boolean): JSX.Element {\n        return <PenControlInterface\n            terrain={this.controller.terrain}\n            term={this.searchTerm}\n            setSearch={(term: string) => this.searchTerm = term}\n            pen={this.middleware}\n        />\n    }\n\n    register(): any {\n        this.controller.terrain.registerMiddleware(this.middleware);\n        console.log('Mounted pen tool.')\n    }\n\n    unregister(): any {\n       this.middleware.eject();\n       console.log('Unmounted pen tool.')\n    }\n\n    isOption(forMobile: boolean, isHost: boolean): boolean {\n        return isHost;\n    }\n}\n\n\nconst PenControlInterface = observer((props: {terrain: Terrain, setSearch: Function, term: string, pen: PenMiddleware}) => {\n    return <div className={'cont'}>\n        <PenSizeSlider pen={props.pen}/>\n        <SpritePicker\n            onSelect={(sp: Sprite) => props.terrain.selectedSprite = sp}\n            onSearch={props.setSearch}\n            defaultTerm={props.term}\n            selected={props.terrain.selectedSprite}\n            canAnimate={false}\n        />\n    </div>\n});\n\nconst PenSizeSlider = observer((props: {pen: PenMiddleware}) => {\n    return <div>\n        <Typography id=\"discrete-slider\" gutterBottom>\n            Pen Size: {props.pen.penSize}\n        </Typography>\n        <Slider\n            value={props.pen.penSize}\n            getAriaValueText={() => `${props.pen.penSize}`}\n            aria-labelledby=\"discrete-slider\"\n            valueLabelDisplay=\"auto\"\n            step={1}\n            marks\n            min={1}\n            max={8}\n            onChange={ (event: any, newValue: any)=> props.pen.penSize = newValue}\n        />\n    </div>\n});\n","import React from \"react\";\nimport UITool from \"./ui-tool\";\nimport ControlCameraIcon from '@material-ui/icons/ControlCamera';\n\nexport default class UICameraTool extends UITool {\n    readonly icon: JSX.Element = <ControlCameraIcon />;\n    readonly name: string = 'Camera';\n\n    getControlUI(forMobile: boolean): JSX.Element|null {\n        return null;\n    }\n\n    register(): any {}\n\n    unregister(): any {}\n\n    isOption(forMobile: boolean, isHost: boolean): boolean {\n        return true;\n    }\n}\n","import React from \"react\";\nimport UITool from \"./ui-tool\";\nimport PenMiddleware from \"../game/middleware/pen-events\";\nimport GameController from \"../game/controllers/game\";\nimport ClearIcon from '@material-ui/icons/Clear';\nimport {observer} from \"mobx-react-lite\";\nimport {Slider, Typography} from \"@material-ui/core\";\n\nexport default class UIEraserTool extends UITool {\n    readonly icon: JSX.Element = <ClearIcon />;\n    readonly name: string = 'Eraser';\n    readonly middleware: PenMiddleware;\n\n    constructor(controller: GameController) {\n        super(controller);\n        this.middleware = new PenMiddleware(controller.terrain, controller.entities, controller.canvasContainer, false);\n    }\n\n    getControlUI(forMobile: boolean): JSX.Element|null {\n        return <EraserSizeSlider pen={this.middleware}/>\n    }\n\n    register(): any {\n        this.controller.terrain.registerMiddleware(this.middleware);\n        console.log('Mounted eraser tool.')\n    }\n\n    unregister(): any {\n        this.middleware.eject();\n        console.log('Unmounted eraser tool.')\n    }\n\n    isOption(forMobile: boolean, isHost: boolean): boolean {\n        return forMobile && isHost;\n    }\n}\n\nconst EraserSizeSlider = observer((props: {pen: PenMiddleware}) => {\n    console.log('PS:', props.pen.penSize)\n\n    return <div>\n        <Typography id=\"discrete-slider\" gutterBottom>\n            Eraser Size: {props.pen.penSize}\n        </Typography>\n        <Slider\n            value={props.pen.penSize}\n            getAriaValueText={() => `${props.pen.penSize}`}\n            aria-labelledby=\"discrete-slider\"\n            valueLabelDisplay=\"auto\"\n            step={1}\n            marks\n            min={1}\n            max={8}\n            onChange={ (event: any, newValue: any)=> props.pen.penSize = newValue}\n        />\n    </div>\n});\n","import UITool from \"./ui-tool\";\nimport FaceIcon from '@material-ui/icons/Face';\nimport React from \"react\";\nimport {observer} from \"mobx-react-lite\";\nimport {SpriteImage, SpritePickerModal} from \"../ui-components/spritepicker\";\nimport EntityLayer, {Entity} from \"../game/controllers/entities\";\nimport {\n    Button,\n    Checkbox,\n    Dialog, DialogActions,\n    DialogContent, DialogContentText,\n    DialogTitle,\n    FormControlLabel, Input, InputLabel, ListItemText, MenuItem, Select,\n    TextField,\n    Typography\n} from \"@material-ui/core\";\nimport {createStyles, makeStyles} from \"@material-ui/core/styles\";\nimport {Sprite} from \"../game/util/sprite-loading\";\nimport FormGroup from \"@material-ui/core/FormGroup\";\nimport GameController from \"../game/controllers/game\";\nimport EntityUpdateHandler from \"../game/net/handlers/entity-update-handler\";\nimport {clients} from '../game/net/peerconnection';\n\n\nexport default class UIEntityTool extends UITool {\n    readonly icon: JSX.Element = <FaceIcon />;\n    readonly name: string = 'Entity';\n\n    getControlUI(forMobile: boolean): JSX.Element {\n        return <EntityInterface\n            entities={this.controller.entities}\n            controller={this.controller}\n        />\n    }\n\n    register(): any {\n        console.log('Mounted entity tool.')\n    }\n\n    unregister(): any {\n        console.log('Unmounted entity tool.')\n    }\n\n    isOption(forMobile: boolean, isHost: boolean): boolean {\n        return isHost;\n    }\n}\n\n\nconst useStyles = makeStyles(() =>\n    createStyles({\n        root: {\n            flexGrow: 1,\n        },\n        speedDial: {\n            position: 'fixed',\n            bottom: 10,\n            right: 10,\n        },\n        spriteColor: {\n            marginLeft: '12px',\n            marginTop: '10px',\n            marginRight: '5px'\n        }\n    })\n);\n\nconst EntityInterface = observer((props: {entities: EntityLayer, controller: GameController}) => {\n    const [promptSprite, setSpritePrompt] = React.useState(false);\n    const [selectedSprite, setSprite] = React.useState(null);\n    const [entName, setName] = React.useState('');\n    const [visible, setVisible] = React.useState(true);\n\n    const resetValues = () => {\n        setSpritePrompt(false);\n        setSprite(null);\n        setName('');\n        setVisible(true);\n    }\n\n    if (props.entities.selected) return <EntityEditInterface entities={props.entities}/>\n\n    return <div className={'cont'}>\n        <h2>Create Entity</h2>\n        <FormGroup row>\n            <TextField\n                id=\"ent-name\"\n                label=\"Name\"\n                variant=\"filled\"\n                value={entName}\n                onChange={(evt) => setName(evt.target.value)}\n            />\n            <div style={{marginLeft: '12px'}} >\n                <SpriteImage\n                    sprite={selectedSprite}\n                    onSelect={() => {setSpritePrompt(true)}}\n                />\n            </div>\n        </FormGroup>\n\n        <FormGroup row>\n            <FormControlLabel\n                control={\n                    <Checkbox\n                        checked={visible}\n                        onChange={(evt)=> setVisible(evt.target.checked)}\n                        name=\"visible\"\n                    />\n                }\n                label=\"Visible\"\n            />\n        </FormGroup>\n\n        <FormGroup row style={{justifyContent: 'space-between'}}>\n            <Button\n                variant=\"contained\"\n                color=\"primary\"\n                onClick={()=>{createEntity(props.entities, props.controller, selectedSprite, entName, visible); resetValues();}}\n                disabled={!selectedSprite || entName.trim().length === 0}\n            >\n                Create\n            </Button>\n            <Button variant=\"contained\" color=\"secondary\" onClick={resetValues} >\n                Clear\n            </Button>\n        </FormGroup>\n\n        <SpritePickerModal\n            open={promptSprite}\n            onClose={()=>setSpritePrompt(false)}\n            onSelect={setSprite}\n            currentSprite={selectedSprite||null}\n        />\n    </div>\n});\n\n\nconst EntityEditInterface = observer((props: {entities: EntityLayer}) => {\n    const ent = props.entities.selected?.entity;\n    if (!ent) return null;\n\n    const [prompt, setSpritePrompt] = React.useState(false);\n    const [promptClone, setClonePrompt] = React.useState(false);\n    const update = React.useMemo(() => {\n        let timeout: any = null;\n        return (info: Partial<Entity>) => {\n            if (timeout !== null) {\n                clearTimeout(timeout);\n            }\n            const ent = props.entities.selected?.entity;\n            if (ent) {\n                timeout = setTimeout(() => {\n                    props.entities.updateEntity(ent.id, info);\n                }, 200);\n            }\n        }\n    }, [props.entities])\n    const classes = useStyles();\n    const updateInstant = (info: Partial<Entity>) => props.entities.updateEntity(ent.id, info);\n    const clientNames: string[] = Array.from(clients).filter(c=>c.userData).map(cl =>{\n        // @ts-ignore\n        return cl.userData.username\n    });\n    const userList: string[] = Array.from(new Set([\n        ...clientNames,\n        ...ent.owners\n    ])).sort();\n\n\n    return <div className={'cont'}>\n        <form className={classes.root} noValidate autoComplete=\"off\" onSubmit={e => e.preventDefault()}>\n            <h2>Edit {ent.name}</h2>\n            <FormGroup row>\n                <TextField\n                    id=\"ent-name\"\n                    label=\"Name\"\n                    variant=\"filled\"\n                    value={ent.name}\n                    onChange={(evt) => updateInstant({name: evt.target.value})}\n                />\n                <div style={{marginLeft: '12px'}} >\n                    <SpriteImage\n                        sprite={ent.sprite}\n                        onSelect={() => {setSpritePrompt(true)}}\n                    />\n                </div>\n\n            </FormGroup>\n            <FormGroup>\n                <FormControlLabel\n                    control={\n                        <input\n                            type=\"color\"\n                            value={ent.color}\n                            className={classes.spriteColor}\n                            onChange={evt => update({color: evt.target.value})}\n                        />\n                    }\n                    label={<Typography style={{marginTop: '12px'}}>Color</Typography>}\n                />\n            </FormGroup>\n            <FormGroup row>\n                <FormControlLabel\n                    control={\n                        <Checkbox\n                            checked={ent.visible}\n                            onChange={(evt)=> {\n                                updateInstant({visible: evt.target.checked});\n                                if (!evt.target.checked) {\n                                    EntityUpdateHandler.sendDelete(ent);\n                                }\n                            }}\n                            name=\"visible\"\n                        />\n                    }\n                    label=\"Visible\"\n                />\n                <FormControlLabel\n                    control={\n                        <Checkbox\n                            checked={ent.saveToCampaign}\n                            onChange={(evt)=> updateInstant({saveToCampaign: evt.target.checked})}\n                            name=\"saveToCampaign\"\n                            color=\"primary\"\n                        />\n                    }\n                    label=\"Campaign-wide\"\n                />\n            </FormGroup>\n\n            <FormGroup>\n                <InputLabel>Owners</InputLabel>\n                <Select\n                    multiple\n                    value={ent.owners}\n                    onChange={(evt)=>updateInstant({owners: evt.target.value as string[]})}\n                    input={<Input />}\n                    renderValue={(selected: any) => selected.join(', ')}\n                    style={{marginBottom: '25px'}}\n                >\n                    {userList.map((id: string) => (\n                        <MenuItem key={id} value={id}>\n                            <Checkbox checked={ent.owners.indexOf(id) > -1} />\n                            <ListItemText primary={id} />\n                        </MenuItem>\n                    ))}\n                </Select>\n            </FormGroup>\n\n            <FormGroup row style={{justifyContent: 'space-between'}}>\n                <Button variant=\"contained\" color=\"default\" onClick={()=>setClonePrompt(true)}>\n                    Duplicate\n                </Button>\n                <Button variant=\"contained\" color=\"secondary\" onClick={()=>props.entities.remove(ent.id)} >\n                    Delete\n                </Button>\n                <Button variant=\"contained\" color=\"primary\" onClick={()=>props.entities.select(null)} >\n                    Close\n                </Button>\n            </FormGroup>\n        </form>\n\n        <SpritePickerModal\n            open={prompt}\n            onClose={()=>setSpritePrompt(false)}\n            onSelect={(sp: Sprite) => {ent.sprite = sp}}\n            currentSprite={ent.sprite}\n        />\n\n        <PromptForNumber\n            onCancel={()=>{ setClonePrompt(false)}}\n            onSubmit={(num: number) => {\n                setClonePrompt(false);\n                if (num) {\n                    cloneEntity(props.entities, ent, num);\n                }\n            }}\n            open = {promptClone}\n            prompt='How many extra clones would you like?'\n            title='Clone Amount'\n            label='Clones'\n        />\n    </div>\n});\n\n\nfunction PromptForNumber(props: {title: string, prompt: string, label?: string, open: boolean, onCancel: Function, onSubmit: Function}) {\n    const [num, setNum] = React.useState(0);\n    const handleClose = (event: any) => {\n        props.onSubmit(num);\n    };\n\n    return <Dialog open={props.open} onClose={()=>{props.onCancel()}} aria-labelledby=\"form-dialog-title\">\n        <DialogTitle id=\"form-dialog-title\">{props.title}</DialogTitle>\n        <DialogContent>\n            <DialogContentText>\n                {props.prompt}\n            </DialogContentText>\n            <TextField\n                autoFocus\n                margin=\"dense\"\n                label={props.label || ''}\n                type=\"number\"\n                fullWidth\n                onChange={(event) => setNum(parseInt(event.target.value))}\n            />\n        </DialogContent>\n        <DialogActions>\n            <Button onClick={()=>{props.onCancel()}} color=\"primary\">\n                Cancel\n            </Button>\n            <Button onClick={handleClose} color=\"primary\">\n                Submit\n            </Button>\n        </DialogActions>\n    </Dialog>\n}\n\n\nfunction cloneEntity(entities: EntityLayer, ent: Entity, num: number) {\n    if (num) {\n        for (let i=0; i<num; i++) {\n            entities.addEntity(ent.sprite, {\n                x: ent.x,\n                y: ent.y,\n                color: ent.color,\n                owners: ent.owners,\n                visible: ent.visible,\n                name: `${ent.name} ${i+2}`\n            });\n        }\n        entities.updateEntity(ent.id, {\n            name: `${ent.name} 1`\n        })\n    }\n}\n\n\nfunction createEntity(entities: EntityLayer, controller: GameController, sprite: Sprite|null, name: string, visible: boolean) {\n    if (!sprite) return;\n\n    const coords = controller.canvasContainer.screenToBoard(window.innerWidth/2, window.innerHeight/2)\n    entities.addEntity(sprite, {\n        name,\n        visible,\n        x: coords.x,\n        y: coords.y\n    })\n}\n","import {observer} from \"mobx-react-lite\";\nimport React from \"react\";\nimport UITool from \"./ui-tool\";\nimport GroupIcon from '@material-ui/icons/Group';\nimport CancelIcon from '@material-ui/icons/Cancel';\nimport ThumbUpIcon from '@material-ui/icons/ThumbUp';\nimport Lobby, {PendingUser} from \"../game/controllers/lobby\";\nimport {createStyles, makeStyles} from \"@material-ui/core/styles\";\nimport {MenuItem, MenuList, Tooltip} from \"@material-ui/core\";\nimport { IconButton } from '@material-ui/core';\nimport * as network from '../game/net/peerconnection'\nimport {updateUser, UserData} from \"../game/db/user-db\";\n\nexport default class UILobbyTool extends UITool {\n    readonly icon: JSX.Element = <GroupIcon />;\n    readonly name: string = 'Lobby';\n\n    getControlUI(forMobile: boolean): JSX.Element | null {\n        return <LobbyInterface lobby={this.controller.lobby}/>;\n    }\n\n    isOption(forMobile: boolean, isHost: boolean): boolean {\n        return isHost;\n    }\n\n    register(): any {}\n\n    unregister(): any {}\n}\n\nconst useStyles = makeStyles(() => createStyles({\n        root: {\n            flexGrow: 1,\n        },\n        speedDial: {\n            position: 'fixed',\n            bottom: 10,\n            right: 10,\n        },\n        spriteColor: {\n            marginLeft: '12px',\n            marginTop: '10px',\n            marginRight: '5px'\n        }\n    }));\n\n\nconst LobbyInterface = observer((props: {lobby: Lobby}) => {\n    const classes = useStyles();\n\n    return <div className={'cont'}>\n        <form className={classes.root} noValidate autoComplete=\"off\" onSubmit={e => e.preventDefault()}>\n            <h2>Lobby</h2>\n            <PendingList lobby={props.lobby} />\n            <UserList />\n        </form>\n    </div>\n});\n\nconst PendingList = observer((props: {lobby: Lobby}) => {\n    const eles = props.lobby.pendingLogins.map(pl => {\n        return <PendingUserEle key={pl.keyCode} user={pl} lobby={props.lobby}/>\n    });\n\n    if(!eles.length) return null;\n\n    return <div>\n        <div style={{border: '1px solid black'}}>\n            <h4 style={{marginBottom: '5px'}}>Pending:</h4>\n            <MenuList>\n                {eles}\n            </MenuList>\n        </div>\n    </div>\n});\n\nconst PendingUserEle = (props: {user: PendingUser, lobby: Lobby}) => {\n    const approve = (ev: any) => {\n        props.lobby.approveUser(props.user)\n        ev.preventDefault();\n        ev.stopPropagation();\n    }\n    const reject = (ev: any) => {\n        props.lobby.rejectUser(props.user)\n        ev.preventDefault();\n        ev.stopPropagation();\n    }\n\n    return <MenuItem style={{justifyContent: 'space-between'}} disableTouchRipple={true}>\n        <Tooltip title={'Device: ' + props.user.keyCode}><div>{props.user.username}</div></Tooltip>\n        <Tooltip title=\"Approve\"><IconButton children={<ThumbUpIcon/>} color=\"primary\" onClick={approve}/></Tooltip>\n        <Tooltip title=\"Kick\"><IconButton children={<CancelIcon />} color=\"secondary\" onClick={reject}/></Tooltip>\n    </MenuItem>\n}\n\n\nconst UserList =  observer((props: {}) => {\n    const eles = Array.from(network.clients).filter(c=>c.userData).map(c => {\n        // @ts-ignore\n        const dat: UserData = c.userData;\n        const reject = (ev: any) => {\n            ev.preventDefault();\n            ev.stopPropagation();\n            updateUser({\n                ...dat,\n                keyCodes: []\n            }).then(() => {\n                c.close()\n            })\n        }\n\n        return <MenuItem key={dat.id} style={{justifyContent: 'space-between'}} disableTouchRipple={true}>\n            {dat.username}\n            <Tooltip title=\"Kick\"><IconButton children={<CancelIcon />} color=\"secondary\" onClick={reject}/></Tooltip>\n        </MenuItem>\n    });\n\n    if (!eles.length) return null;\n\n    return <div>\n        <h4 style={{marginBottom: '5px'}}>Online:</h4>\n        <MenuList>\n            {eles}\n        </MenuList>\n    </div>\n});\n","import React from 'react';\nimport { makeStyles, createStyles, Theme } from '@material-ui/core/styles';\nimport SpeedDial from '@material-ui/lab/SpeedDial';\nimport SpeedDialIcon from '@material-ui/lab/SpeedDialIcon';\nimport SpeedDialAction from '@material-ui/lab/SpeedDialAction';\nimport UIPenTool from \"../ui-tools/ui-pen-tool\";\nimport GameController from \"../game/controllers/game\";\nimport UITool from \"../ui-tools/ui-tool\";\nimport {Avatar, Modal} from \"@material-ui/core\";\nimport UICameraTool from \"../ui-tools/ui-camera-tool\";\nimport MoreHorizIcon from '@material-ui/icons/MoreHoriz';\nimport UIEraserTool from \"../ui-tools/ui-eraser-tool\";\nimport {observer} from \"mobx-react-lite\";\nimport * as connection from \"../game/net/peerconnection\";\nimport {NetworkMode} from \"../game/net/peerconnection\";\nimport UIEntityTool from \"../ui-tools/ui-entity-tool\";\nimport UILobbyTool from \"../ui-tools/ui-lobby-tool\";\n\nconst useStyles = makeStyles((theme: Theme) =>\n    createStyles({\n        root: {\n            height: 380,\n            transform: 'translateZ(0px)',\n            flexGrow: 1,\n        },\n        speedDial: {\n            position: 'fixed',\n            bottom: 10,\n            right: 10,\n        },\n        paper: {\n            backgroundColor: theme.palette.background.paper,\n            border: '2px solid #000',\n            boxShadow: theme.shadows[5],\n            padding: theme.spacing(2, 4, 3),\n            pointerEvents: 'auto'\n        }\n    }),\n);\n\n\nconst ControlMenu = observer((props: {controller: GameController, forMobile: boolean}) => {\n    const isHost = connection.netMode.get() === NetworkMode.HOST;\n    const classes = useStyles();\n    const [open, setOpen] = React.useState(false);\n    const [modalOpen, setModalOpen] = React.useState(false);\n    const [tools, setTools] = React.useState<UITool[]>([]);\n    const [selectedTool, setSelected] = React.useState<UITool|null>(null);\n\n    const handleOpen = () => {\n        setOpen(true);\n    };\n\n    const handleClose = () => {\n        setOpen(false);\n    };\n\n    const handleModalClose = () => {\n        setModalOpen(false);\n    };\n\n    const handleModalOpen = () => {\n        setModalOpen(true);\n    }\n\n    const handleSelect = (action: UITool) => {\n        handleClose();\n        if (action === selectedTool) {\n            return;\n        }\n        if (selectedTool) {\n            selectedTool.unregister();\n        }\n        setSelected(action);\n        action.register();\n        setModalOpen(true);\n    }\n\n    React.useEffect(() => {\n        // When the back button is used, close the modal.\n        window.addEventListener('popstate', handleModalClose);\n\n        return () => {\n            window.removeEventListener('popstate', handleModalClose);\n        }\n    });\n\n    React.useEffect(() => {\n        const tools = [\n            new UICameraTool(props.controller),\n            new UIPenTool(props.controller),\n            new UIEraserTool(props.controller),\n            new UIEntityTool(props.controller),\n            new UILobbyTool(props.controller)\n        ];\n\n        setTools(tools);\n        setSelected(tools[0]);\n        tools[0].register();\n    }, [props.controller]);\n\n    let ui;\n    const emb = selectedTool?.getControlUI(true);\n    if (emb) {\n        if (props.forMobile) {\n            ui = <div>\n                <Avatar\n                    className={'useMouse'}\n                    onClick={handleModalOpen}\n                    style={{\n                        position: 'fixed',\n                        bottom: '10px',\n                        left: '10px',\n                        transform: `translateY(-50%)`,\n                        background: '#3eec10',\n                        cursor: 'pointer'\n                    }}\n                >\n                    <MoreHorizIcon/>\n                </Avatar>\n                <Modal open={modalOpen} onClose={handleModalClose}>\n                    <div className={classes.paper}>\n                        {emb}\n                    </div>\n                </Modal>\n            </div>\n        } else {\n            ui = <div\n                style={{position: \"fixed\", left: '10px', top: '50%', minWidth: '400px', transform: `translateY(-50%)`}}\n                className={classes.paper}\n            >\n                {selectedTool?.getControlUI(false)}\n            </div>\n        }\n    }\n\n    return <div>\n        {ui}\n        <SpeedDial\n            ariaLabel=\"Control SpeedDial\"\n            className={classes.speedDial}\n            hidden={false}\n            icon={selectedTool?.icon || <SpeedDialIcon />}\n            onClose={handleClose}\n            onOpen={handleOpen}\n            open={!props.forMobile || open}\n        >\n            {tools.filter(t=>t.isOption(props.forMobile, isHost)).map((action) => (\n                <SpeedDialAction\n                    key={action.name}\n                    icon={action.icon}\n                    tooltipTitle={action.name}\n                    tooltipOpen\n                    onClick={() => {handleSelect(action)}}\n                    title={action.name}\n                />\n            ))}\n        </SpeedDial>\n    </div>\n});\n\nexport default ControlMenu;\n","import React from \"react\";\nimport {\n    Button,\n    Dialog,\n    DialogActions,\n    DialogContent,\n    DialogContentText,\n    DialogTitle,\n    TextField\n} from \"@material-ui/core\";\n\nexport function InputDialog(props: {\n    open: boolean\n    title: string,\n    body: string,\n    tooltip: string,\n    onSubmit: Function,\n    onCancel: Function,\n    acceptText?: string\n}) {\n    const [text, setText] = React.useState('');\n\n    const handleClose = () => {\n        props.onCancel();\n    };\n    const handleText = (event: React.ChangeEvent<HTMLInputElement>) => {\n        setText(event.target.value);\n    }\n\n    return (\n        <div>\n            <Dialog open={props.open} onClose={handleClose} aria-labelledby=\"form-dialog-title\">\n                <DialogTitle id=\"form-dialog-title\">{props.title}</DialogTitle>\n                <DialogContent>\n                    <DialogContentText>\n                        {props.body}\n                    </DialogContentText>\n                    <TextField\n                        autoFocus\n                        margin=\"dense\"\n                        id=\"name\"\n                        label={props.tooltip}\n                        type=\"text\"\n                        fullWidth\n                        value={text}\n                        onChange={handleText}\n                    />\n                </DialogContent>\n                <DialogActions>\n                    <Button onClick={() => {\n                        handleClose();\n                        props.onCancel()\n                    }} color=\"primary\">\n                        Cancel\n                    </Button>\n                    <Button onClick={() => {\n                        props.onSubmit(text);\n                        setText('')\n                    }} color=\"primary\">\n                        {props.acceptText || 'Connect'}\n                    </Button>\n                </DialogActions>\n            </Dialog>\n        </div>\n    );\n}\n\n\n\nexport default function ConfirmPrompt(props: {\n    open: boolean,\n    onCancel: any,\n    onConfirm: any,\n    title: string,\n    prompt: string,\n    confirmButton?: string,\n    cancelButton?: string\n}) {\n    return (\n        <div>\n            <Dialog\n                open={props.open}\n                onClose={props.onCancel}\n                aria-labelledby=\"confirm-dialog-title\"\n                aria-describedby=\"confirm-dialog-description\"\n            >\n                <DialogTitle className=\"confirm-dialog-title\">{props.title}</DialogTitle>\n                <DialogContent>\n                    <DialogContentText className=\"prompt-dialog-description\">\n                        {props.prompt}\n                    </DialogContentText>\n                </DialogContent>\n                <DialogActions>\n                    <Button onClick={props.onCancel} color=\"primary\">\n                        {props.cancelButton||'cancel'}\n                    </Button>\n                    <Button onClick={props.onConfirm} color=\"primary\" autoFocus>\n                        {props.confirmButton||'confirm'}\n                    </Button>\n                </DialogActions>\n            </Dialog>\n        </div>\n    );\n}\n","import React from \"react\";\nimport GameController from \"../game/controllers/game\";\nimport {Button, Dialog, DialogActions, DialogContent, DialogContentText, DialogTitle} from \"@material-ui/core\";\nimport {InputDialog} from \"./prompts\";\n\n/**\n * Helper UI to prompt the user for their connection action, if no Room ID hashcode is set.\n * @param props\n * @constructor\n */\nexport default function LoginHelper (props: {controller: GameController}) {\n    const [promptLogin, setPrompt] = React.useState(true);\n    const [needClient, setNeedClient] = React.useState(false);\n\n    const setHosting = (hosting: boolean) => {\n        setPrompt(false);\n        if (hosting) {\n            return props.controller.startHost();\n        } else {\n           setNeedClient(true);\n        }\n    };\n\n    return <div>\n        { promptLogin ? <PromptNetwork select={setHosting}/> : null }\n        <InputDialog\n            open={needClient}\n            title={'Enter host ID'}\n            body={'Enter the ID of the host lobby you\\'d like to join'}\n            tooltip={'Host ID'}\n            onCancel={() => {setNeedClient(false); setPrompt(true)}}\n            onSubmit={(txt: string) => props.controller.startClient(txt)}\n        />\n    </div>\n}\n\n\nfunction PromptNetwork (props: {select: Function}) {\n\n    return <Dialog open={true} aria-labelledby=\"form-dialog-title\">\n        <DialogTitle id=\"form-dialog-title\">Network Mode</DialogTitle>\n        <DialogContent>\n            <DialogContentText>\n                Would you like to join a campaign, or host your own campaign?\n            </DialogContentText>\n        </DialogContent>\n        <DialogActions>\n            <Button onClick={() => {props.select(true)}}>\n                Host\n            </Button>\n            <Button onClick={() => { props.select(false)}}>\n                Join\n            </Button>\n        </DialogActions>\n    </Dialog>\n}\n","import * as connection from \"../game/net/peerconnection\";\nimport {NetworkMode, NetworkStatus} from \"../game/net/peerconnection\";\nimport LoginHelper from \"./loginHelper\";\nimport Backdrop from \"@material-ui/core/Backdrop\";\nimport {Typography} from \"@material-ui/core\";\nimport React from \"react\";\nimport GameController from \"../game/controllers/game\";\n\n/**\n * Util to display network status to the user.\n * @param props\n * @constructor\n */\nexport default function ConnectionOverlay(props: {controller: GameController}) {\n    let content = null;\n    let message = null;\n\n    if (connection.netMode.get() === NetworkMode.UNKNOWN) {\n        content = <LoginHelper controller={props.controller} />\n\n    } else {\n        switch (connection.netStatus.get()) {\n            case NetworkStatus.DISCONNECTED:\n                message = `Error connecting to service. Cannot reconnect.`;\n                break;\n            case NetworkStatus.RECONNECTING:\n                message = 'Error with connection to Host. Attempting reconnection...';\n                break;\n            case NetworkStatus.CONNECTING:\n                message = 'Connecting to Host...';\n                break;\n            case NetworkStatus.MATCHMAKING:\n                message = 'Connecting to matchmaking server...';\n                break;\n            case NetworkStatus.MATCHMAKING_FAIL:\n                message = 'Connection to matchmaking server failed. Please reload.';\n                break;\n            case NetworkStatus.WAITING_FOR_HOST:\n                message = 'Waiting for the Host to approve our login...';\n                break;\n            default:\n                message = null;\n        }\n    }\n\n    if (message) {\n        content =  <Backdrop open={true} transitionDuration={0}>\n            <Typography variant=\"h4\" component=\"h4\" gutterBottom>\n                {message}\n            </Typography>\n        </Backdrop>;\n    }\n    return content;\n}\n","import React from \"react\";\nimport GameController from \"../game/controllers/game\";\nimport * as Metadata from \"../game/db/metadata-db\";\nimport CampaignLoader from \"../game/data/campaign-loader\";\nimport {observer} from \"mobx-react-lite\";\nimport Campaign from \"../game/controllers/campaign\";\nimport SettingsIcon from '@material-ui/icons/Settings';\nimport AddCircleOutlineIcon from '@material-ui/icons/AddCircleOutline';\nimport {\n    Button,\n    Dialog,\n    DialogContent,\n    DialogTitle,\n    Fab,\n    InputLabel,\n    Menu,\n    MenuItem,\n    Tooltip\n} from \"@material-ui/core\";\nimport {netMode, NetworkMode} from \"../game/net/peerconnection\";\nimport {InputDialog} from \"./prompts\";\n\n\nexport const CampaignSelector = observer((props: {controller: GameController}) => {\n    const [need, setNeed] = React.useState(true);\n    const [wantOpen, setWantOpen] = React.useState(false);\n    const [promptNew, setPromptNew] = React.useState(false);\n    const [campaignList, setList] = React.useState<Campaign[]>([]);\n    const [storage, setStorage] = React.useState({q: 1, u: 0});\n\n\n    const selectCampaign = React.useMemo(() => {\n        return (camp: Campaign) => {\n            setNeed(false);\n            props.controller.campaign = camp;\n            Metadata.setCurrentCampaign(camp.id).then();\n            if (props.controller.campaign.loadedBoard) {\n                props.controller.loadBoard(props.controller.campaign.loadedBoard).then();\n            }\n        }\n    }, [props.controller]);\n\n    React.useMemo(() => {\n        // Check initially to see if we already have a username stored:\n        Metadata.getCurrentCampaign().then(async id => {\n            if (id === null) return;\n            console.debug('Current campaign:', id);\n            const camp = await CampaignLoader.loadCampaign(id);\n            if (!camp) return;\n            selectCampaign(camp);\n        });\n\n        // Load all available campaigns:\n        CampaignLoader.getAvailable().then(campaigns => setList(campaigns));\n\n        // Lookup used storage:\n        navigator.storage.estimate().then(function(estimate) {\n            const u = estimate.usage;\n            const q = estimate.quota\n            if (u !== undefined && q !== undefined) setStorage({ q, u});\n        });\n    }, [selectCampaign]);\n\n    const addCampaign = async (name: string) => {\n        setPromptNew(false);\n        if (name.trim().length) {\n            const c = await CampaignLoader.createCampaign(name);\n            setList([...campaignList, c]);\n        }\n    }\n\n    const handleModalClose = () => {\n        if (!need) {\n            setWantOpen(false);\n        }\n    }\n\n    if (netMode.get() !== NetworkMode.HOST) return null;\n\n    return <div className={'menu_button'}>\n        <Tooltip\n            title=\"Campaign Settings\"\n            style={{\n                pointerEvents: 'auto'\n            }}\n        >\n            <Fab\n                color=\"primary\"\n                onClick={()=>{setWantOpen(true)}}\n            >\n                <SettingsIcon />\n            </Fab>\n        </Tooltip>\n\n        <Dialog open={need || wantOpen} onClose={handleModalClose}>\n            <DialogTitle style={{textAlign: \"center\"}}>Campaign Info</DialogTitle>\n            <DialogContent style={{textAlign: \"center\"}}>\n                <CampaignMenu campaigns={campaignList} onSelect={selectCampaign} selected={props.controller.campaign}/>\n                <Button\n                    variant=\"contained\"\n                    color=\"default\"\n                    onClick={()=>setPromptNew(true)}\n                    startIcon={<AddCircleOutlineIcon />}\n                >\n                    Create New Campaign\n                </Button>\n                <p style={{color: 'gray'}}>\n                    {\n                        storage ?\n                            `${(storage.u/storage.q * 100).toFixed(2)}% used of ${formatBytes(storage.q)}`\n                            : 'Storage metrics unknown'\n                    }\n                </p>\n            </DialogContent>\n        </Dialog>\n        <InputDialog\n            open={promptNew}\n\t\t\ttitle='New Campaign'\n\t\t\tbody='Enter a name for the new Campaign:'\n\t\t\tacceptText={'Create'}\n\t\t\ttooltip={'Campaign Name'}\n\t\t\tonSubmit={addCampaign}\n\t\t\tonCancel={()=>setPromptNew(false)}\n\t\t/>\n    </div>\n})\n\n\nexport function CampaignMenu(props: {campaigns: Campaign[], onSelect: Function, selected: Campaign|null}) {\n    const [anchorEl, setAnchorEl] = React.useState<null | HTMLElement>(null);\n    const [selected, setSelected] = React.useState<Campaign|null>(props.selected);\n\n    const handleClick = (event: React.MouseEvent<HTMLButtonElement>) => {\n        setAnchorEl(event.currentTarget);\n    };\n\n    const handleClose = (campaign: Campaign|null) => {\n        if (campaign) {\n            setSelected(campaign);\n            props.onSelect(campaign);\n        }\n        setAnchorEl(null);\n    };\n\n    const camps = props.campaigns.sort((c1, c2)=>c1.timeCreated-c2.timeCreated).map(c => {\n        return <MenuItem key={c.id} onClick={()=>handleClose(c)}>\n            <b>{c.name}</b>&nbsp;-&nbsp;<i>[{new Date(c.timeCreated).toLocaleString()}]</i>\n        </MenuItem>\n    });\n\n    return (\n        <div style={{marginBottom: '20px'}}>\n            <InputLabel htmlFor='campaign-list-btn'>Current Campaign:</InputLabel>\n            <Button\n                variant='outlined'\n                onClick={handleClick}\n                id={'campaign-list-btn'}\n                disabled={props.campaigns.length===0}\n                style={{maxWidth: '300px', minWidth: '200px', overflowX: 'hidden'}}\n            >\n                {selected? selected.name : (props.campaigns.length ? 'Select a Campaign':'No campaigns exist')}\n            </Button>\n            <Menu\n                id=\"simple-menu\"\n                anchorEl={anchorEl}\n                keepMounted\n                open={Boolean(anchorEl)}\n                onClose={()=>handleClose(null)}\n                anchorOrigin={{ vertical: \"bottom\", horizontal: \"center\" }}\n                transformOrigin={{ vertical: \"top\", horizontal: \"center\" }}\n            >\n                {camps}\n            </Menu>\n        </div>\n    );\n}\n\n\nfunction formatBytes(bytes: number, decimals = 2) {\n    if (bytes === 0) return '0 Bytes';\n\n    const k = 1024;\n    const dm = decimals < 0 ? 0 : decimals;\n    const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];\n\n    const i = Math.floor(Math.log(bytes) / Math.log(k));\n\n    return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];\n}\n","import React from \"react\";\nimport {observer} from \"mobx-react-lite\";\nimport {Button, Fab, MenuItem, MenuList, Popover, Tooltip, Typography} from \"@material-ui/core\";\nimport MapIcon from '@material-ui/icons/Map';\nimport GameController from \"../game/controllers/game\";\nimport {netMode, NetworkMode} from \"../game/net/peerconnection\";\nimport Campaign from \"../game/controllers/campaign\";\nimport FormGroup from \"@material-ui/core/FormGroup\";\nimport notifications from './notifications';\nimport ConfirmPrompt, {InputDialog} from \"./prompts\";\n\n\n\nexport const BoardSelector = observer((props: {controller: GameController}) => {\n    const [anchorEl, setAnchorEl] = React.useState<HTMLElement | null>(null);\n    const campaign = props.controller.campaign;\n    if (netMode.get() !== NetworkMode.HOST) return null;\n\n    if (!campaign) return null;\n\n    return <div style={{pointerEvents: 'auto',}}>\n        <Tooltip\n            title=\"Selected Board\"\n        >\n            <Fab\n                variant=\"extended\"\n                onClick={(evt: any)=>{setAnchorEl(evt.currentTarget)}}\n                style={{width: '200px', overflowX: 'hidden', marginTop: '5px'}}\n            >\n                <MapIcon style={{marginRight: '5px'}}/>\n                <Typography variant=\"inherit\" noWrap>\n                    {campaign?.loadedBoard ? campaign.loadedBoard : '[Untitled Board]'}\n                </Typography>\n            </Fab>\n        </Tooltip>\n        <Popover\n            open={!!anchorEl}\n            anchorEl={anchorEl}\n            onClose={()=>setAnchorEl(null)}\n            anchorOrigin={{\n                vertical: 'bottom',\n                horizontal: 'center',\n            }}\n            transformOrigin={{\n                vertical: 'top',\n                horizontal: 'center',\n            }}\n        >\n            <BoardControlMenu campaign={campaign} controller={props.controller}/>\n        </Popover>\n    </div>\n});\n\nexport const BoardControlMenu = (props: {controller: GameController, campaign: Campaign}) => {\n    const [selected, setSelected] = React.useState(props.campaign.loadedBoard);\n\n    const handleSelected = (board: string) => {\n        setSelected(board);\n    }\n\n    return <form\n        style={{\n            flexGrow: 1,\n            width: '300px'\n        }}\n        noValidate\n        autoComplete=\"off\"\n        onSubmit={e => e.preventDefault()}\n    >\n        <FormGroup row>\n            <BoardSelectMenu campaign={props.campaign} onSelect={handleSelected}/>\n        </FormGroup>\n        <FormGroup row>\n            <BoardLoadButton controller={props.controller} selected={selected} setSelected={setSelected} />\n            <BoardDeleteButton controller={props.controller} campaign={props.campaign} selected={selected} setSelected={setSelected} />\n            <BoardCreateButton controller={props.controller} campaign={props.campaign} selected={selected} setSelected={setSelected} />\n        </FormGroup>\n    </form>\n}\n\n\nexport const BoardSelectMenu = observer((props: {campaign: Campaign, onSelect: Function}) => {\n    const [selected, setSelected] = React.useState(props.campaign.loadedBoard);\n\n    const boards = props.campaign.boards.map(b => {\n        return <MenuItem\n            key={b}\n            onClick={() => {setSelected(b); props.onSelect(b)}}\n            selected={b === selected}\n        >\n            <Typography\n                variant=\"inherit\"\n                noWrap\n                color={b === props.campaign.loadedBoard ? 'textSecondary':'initial'}\n            >\n                {b}\n            </Typography>\n        </MenuItem>\n    });\n\n    return <MenuList style={{maxHeight: '400px',  overflow: 'auto', width: '100%'}}>\n        {boards}\n    </MenuList>;\n});\n\nexport const BoardLoadButton = (props: {controller: GameController, selected: string|null, setSelected: Function}) => {\n    return <Button\n        color=\"primary\"\n        disabled={props.controller.campaign?.loadedBoard === props.selected}\n        onClick={() => {\n            if (props.selected) {\n                props.controller.loadBoard(props.selected).then();\n            }\n        }}\n    >\n        Load\n    </Button>\n};\n\nexport const BoardDeleteButton = (props: {\n    controller: GameController,\n    campaign: Campaign,\n    selected: string|null,\n    setSelected: Function\n}) => {\n    const [confirm, needConfirm] = React.useState(false);\n\n    return <div>\n        <Button\n            disabled={!props.selected}\n            color=\"secondary\"\n            onClick={() => {needConfirm(true)}}\n        >\n            Delete\n        </Button>\n        <ConfirmPrompt\n            open={confirm}\n            onCancel={() => {needConfirm(false)}}\n            onConfirm={() => {\n                if (props.selected) {\n                    props.controller.deleteBoard(props.campaign, props.selected).catch(err => {\n                        notifications.error('Failed to delete board!');\n                        console.error(err);\n                    });\n                    props.setSelected(null);\n                    needConfirm(false);\n                }\n            }}\n            title={'Really delete?'}\n            prompt={`Are you sure you want to delete the board \"${props.selected}\"?`}\n            confirmButton={'Delete'}\n        />\n    </div>\n};\n\nexport const BoardCreateButton = (props: {\n    controller: GameController,\n    campaign: Campaign,\n    selected: string|null,\n    setSelected: Function\n}) => {\n    const [needPrompt, setPrompt] = React.useState(false);\n    const handleCreate = (name: string) => {\n        setPrompt(false);\n        if (props.campaign.boards.includes(name)) {\n            return notifications.error('All board names must be unique!')\n        }\n        if (name && name.trim().length) {\n            props.campaign.boards.push(name);\n            props.setSelected(name);\n            props.controller.loadBoard(name).then();\n        }\n    }\n\n    return <div>\n        <Button\n            style={{color: 'rgba(25,160,7,0.94)'}}\n            onClick={() => {\n                setPrompt(true);\n            }}\n        >\n            New\n        </Button>\n        <InputDialog\n            open={needPrompt}\n            title='Create a Board'\n            body='Enter the name for the new Board:'\n            tooltip={'Board name'}\n            acceptText={'Create'}\n            onSubmit={handleCreate}\n            onCancel={handleCreate}\n        />\n    </div>\n};\n","import {observer} from \"mobx-react-lite\";\nimport {Fab, Tooltip} from \"@material-ui/core\";\nimport SaveIcon from '@material-ui/icons/Save';\nimport React from \"react\";\nimport GameController from \"../game/controllers/game\";\n\n\nexport const BoardSaveButton = observer( (props: {controller: GameController}) => {\n    const shouldSave = props.controller.campaign?.loadedBoard &&\n        (props.controller.entities.isDirty || props.controller.terrain.isBoardDirty);\n\n    return <Tooltip\n        title={shouldSave ? \"Save Board\" : \"No changes to save.\"}\n        style={{\n            pointerEvents: 'auto'\n        }}\n    >\n        <span>\n            <Fab\n                color=\"primary\"\n                onClick={()=>{props.controller.saveBoard().then()}}\n                disabled={!shouldSave}\n            >\n                <SaveIcon />\n            </Fab>\n        </span>\n    </Tooltip>\n});\n","import React from 'react';\nimport './styles/App.scss';\nimport './styles/canvas-style.scss';\nimport GameController from \"./game/controllers/game\";\nimport useMediaQuery from '@material-ui/core/useMediaQuery';\nimport Backdrop from '@material-ui/core/Backdrop';\nimport CircularProgress from '@material-ui/core/CircularProgress';\nimport {Typography} from \"@material-ui/core\";\nimport ControlMenu from \"./ui-components/controlMenu\";\nimport {observer} from \"mobx-react-lite\";\nimport ConnectionOverlay from \"./ui-components/connectionOverlay\";\nimport { SnackbarProvider } from 'notistack';\nimport * as connection from \"./game/net/peerconnection\";\nimport {NetworkMode} from \"./game/net/peerconnection\";\nimport {SnackbarUtilsConfigurator} from \"./ui-components/notifications\";\nimport * as metadata from './game/db/metadata-db';\nimport {CampaignSelector} from \"./ui-components/campaignSelector\";\nimport {BoardSelector} from \"./ui-components/boardSelector\";\nimport {BoardSaveButton} from \"./ui-components/boardSaveButton\";\nimport {InputDialog} from \"./ui-components/prompts\";\n\n\nif (!('PointerEvent' in window)) {\n    alert('This browser does not support pointer events - please use a different one!');\n}\n\nconst controller = new GameController();\n\nif (process.env.NODE_ENV !== 'development') {\n    console.info('Shutting the console up for non-dev build.');\n    function noop() {}\n    console.debug = noop;\n    console.log = noop;\n    console.info = noop;\n}\n\nconst App = observer(() => {\n    const desktop = useMediaQuery('(min-width:900px)');\n    const [needName, setNeedName] = React.useState(true);\n    const setName = async (name: string) => {\n        if (name && name.length) {\n            setNeedName(false);\n            await metadata.setUsername(name);\n            await controller.start();\n        } else {\n            window.location.reload();\n        }\n    }\n    React.useMemo(() => {\n        // Check initially to see if we already have a username stored:\n        metadata.getUsername().then(async name => {\n            if (name && name.length) {\n               setNeedName(false);\n               await controller.start();\n            }\n        })\n    }, []);\n\n    let content: JSX.Element|null = null;\n\n    if (needName) {\n        content = <InputDialog\n            open={needName}\n            title='Choose a Name'\n            body='Enter the name you want to go by:'\n            tooltip={'Name'}\n            onSubmit={setName}\n            onCancel={setName}\n        />;\n    } else if (!controller.ready && connection.netMode.get() === NetworkMode.UNKNOWN) {\n        content = <Backdrop open={true} transitionDuration={0}>\n            <Typography variant=\"h1\" component=\"h2\" gutterBottom>\n                Loading <CircularProgress color=\"inherit\" />\n            </Typography>\n        </Backdrop>;\n    } else if (controller.isNetworkReady) {\n        content = <ControlMenu controller={controller} forMobile={!desktop}/>\n    } else if (!controller.isNetworkReady) {\n        content = <ConnectionOverlay controller={controller} />;\n    }\n\n    return (\n        <SnackbarProvider maxSnack={5}>\n            <SnackbarUtilsConfigurator />\n            <div className=\"App noMouse\">\n                <div style={{\n                    display: 'flex',\n                    pointerEvents: 'none',\n                    flexDirection: 'row',\n                    position: 'fixed',\n                    top: '10px',\n                    left: '10px'\n                }}>\n                    <CampaignSelector controller={controller}/>\n                    <BoardSelector controller={controller}/>\n                    <BoardSaveButton controller={controller} />\n                </div>\n\n                {content}\n            </div>\n        </SnackbarProvider>\n    )\n});\n\nexport default App;\n","// This optional code is used to register a service worker.\n// register() is not called by default.\n\n// This lets the app waitForSpriteLoad faster on subsequent visits in production, and gives\n// it offline capabilities. However, it also means that developers (and users)\n// will only see deployed updates on subsequent visits to a page, after all the\n// existing tabs open on the page have been closed, since previously cached\n// resources are updated in the background.\n\n// To learn more about the benefits of this model and instructions on how to\n// opt-in, read https://bit.ly/CRA-PWA\n\nconst isLocalhost = Boolean(\n  window.location.hostname === 'localhost' ||\n    // [::1] is the IPv6 localhost address.\n    window.location.hostname === '[::1]' ||\n    // 127.0.0.0/8 are considered localhost for IPv4.\n    window.location.hostname.match(\n      /^127(?:\\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/\n    )\n);\n\ntype Config = {\n  onSuccess?: (registration: ServiceWorkerRegistration) => void;\n  onUpdate?: (registration: ServiceWorkerRegistration) => void;\n};\n\nexport function register(config?: Config) {\n  if (process.env.NODE_ENV === 'production' && 'serviceWorker' in navigator) {\n    // The URL constructor is available in all browsers that support SW.\n    const publicUrl = new URL(\n      process.env.PUBLIC_URL,\n      window.location.href\n    );\n    if (publicUrl.origin !== window.location.origin) {\n      // Our service worker won't work if PUBLIC_URL is on a different origin\n      // from what our page is served on. This might happen if a CDN is used to\n      // serve assets; see https://github.com/facebook/create-react-app/issues/2374\n      return;\n    }\n\n    window.addEventListener('load', () => {\n      const swUrl = `${process.env.PUBLIC_URL}/service-worker.js`;\n\n      if (isLocalhost) {\n        // This is running on localhost. Let's check if a service worker still exists or not.\n        checkValidServiceWorker(swUrl, config);\n\n        // Add some additional logging to localhost, pointing developers to the\n        // service worker/PWA documentation.\n        navigator.serviceWorker.ready.then(() => {\n          console.log(\n            'This web app is being served cache-first by a service ' +\n              'worker. To learn more, visit https://bit.ly/CRA-PWA'\n          );\n        });\n      } else {\n        // Is not localhost. Just register service worker\n        registerValidSW(swUrl, config);\n      }\n    });\n  }\n}\n\nfunction registerValidSW(swUrl: string, config?: Config) {\n  navigator.serviceWorker\n    .register(swUrl)\n    .then(registration => {\n      registration.onupdatefound = () => {\n        const installingWorker = registration.installing;\n        if (installingWorker == null) {\n          return;\n        }\n        installingWorker.onstatechange = () => {\n          if (installingWorker.state === 'installed') {\n            if (navigator.serviceWorker.controller) {\n              // At this point, the updated precached content has been fetched,\n              // but the previous service worker will still serve the older\n              // content until all client tabs are closed.\n              console.log(\n                'New content is available and will be used when all ' +\n                  'tabs for this page are closed. See https://bit.ly/CRA-PWA.'\n              );\n\n              // Execute callback\n              if (config && config.onUpdate) {\n                config.onUpdate(registration);\n              }\n            } else {\n              // At this point, everything has been precached.\n              // It's the perfect time to display a\n              // \"Content is cached for offline use.\" message.\n              console.log('Content is cached for offline use.');\n\n              // Execute callback\n              if (config && config.onSuccess) {\n                config.onSuccess(registration);\n              }\n            }\n          }\n        };\n      };\n    })\n    .catch(error => {\n      console.error('Error during service worker registration:', error);\n    });\n}\n\nfunction checkValidServiceWorker(swUrl: string, config?: Config) {\n  // Check if the service worker can be found. If it can't reload the page.\n  fetch(swUrl, {\n    headers: { 'Service-Worker': 'script' }\n  })\n    .then(response => {\n      // Ensure service worker exists, and that we really are getting a JS file.\n      const contentType = response.headers.get('content-type');\n      if (\n        response.status === 404 ||\n        (contentType != null && contentType.indexOf('javascript') === -1)\n      ) {\n        // No service worker found. Probably a different app. Reload the page.\n        navigator.serviceWorker.ready.then(registration => {\n          registration.unregister().then(() => {\n            window.location.reload();\n          });\n        });\n      } else {\n        // Service worker found. Proceed as normal.\n        registerValidSW(swUrl, config);\n      }\n    })\n    .catch(() => {\n      console.log(\n        'No internet connection found. App is running in offline mode.'\n      );\n    });\n}\n\nexport function unregister() {\n  if ('serviceWorker' in navigator) {\n    navigator.serviceWorker.ready\n      .then(registration => {\n        registration.unregister();\n      })\n      .catch(error => {\n        console.error(error.message);\n      });\n  }\n}\n","import 'mobx-react-lite/batchingForReactDom'\nimport React from 'react';\nimport ReactDOM from 'react-dom';\nimport App from './App';\nimport * as serviceWorker from './serviceWorker';\nimport 'fontsource-roboto';\n\nReactDOM.render(\n  //<React.StrictMode>\n    <App />,\n  //</React.StrictMode>,\n  document.getElementById('root')\n);\n\n// If you want your app to work offline and load faster, you can change\n// unregister() to register() below. Note this comes with some pitfalls.\n// Learn more about service workers: https://bit.ly/CRA-PWA\nserviceWorker.unregister();\n\n","module.exports = require('comlink').wrap(require(\"!worker-loader?{}!/home/runner/work/Terra/Terra/web-ui/node_modules/comlink-loader/dist/comlink-worker-loader.js!/home/runner/work/Terra/Terra/web-ui/node_modules/react-scripts/node_modules/babel-loader/lib/index.js??ref--7-oneOf-1!/home/runner/work/Terra/Terra/web-ui/node_modules/eslint-loader/dist/cjs.js??ref--6-0!/home/runner/work/Terra/Terra/web-ui/src/game/data/board-packer.worker.ts\")());module.exports.__esModule = true;"],"sourceRoot":""}